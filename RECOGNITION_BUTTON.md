# è¯†åˆ«æŒ‰é’®åŠŸèƒ½è¯´æ˜

## âœ¨ åŠŸèƒ½æ¦‚è¿°

è¯†åˆ«æŒ‰é’®å®ç°äº†å®Œæ•´çš„äº‘ç«¯é¢æ–™è¯†åˆ«æµç¨‹ï¼Œæ”¯æŒï¼š
1. åŠ¨æ€å¼•æ“é€‰æ‹©
2. å®æ—¶ API è°ƒç”¨
3. Top-3 æè´¨æ˜¾ç¤º
4. ç½®ä¿¡åº¦å¯è§†åŒ–
5. æ¨ç†æ–‡æœ¬å±•ç¤º
6. å®Œå–„çš„é”™è¯¯å¤„ç†

## ğŸ¯ æ ¸å¿ƒå®ç°

### 1. æŒ‰é’®è§¦å‘ (Line 105)

```python
if st.button("è¯†åˆ«è¯¥åŒºåŸŸ", use_container_width=True):
```

**ç‰¹æ€§**:
- `use_container_width=True`: æŒ‰é’®å æ»¡å®¹å™¨å®½åº¦
- ä¸»è¦æ“ä½œæŒ‰é’®ï¼Œè§†è§‰çªå‡º

### 2. å›¾åƒä¿å­˜ (Line 107-111)

```python
os.makedirs(".cache/crops", exist_ok=True)
# Save temp patch
key = md5(preview.tobytes()).hexdigest()[:10]
patch_path = f".cache/crops/{key}.png"
preview.save(patch_path)
```

**å·¥ä½œæµç¨‹**:
1. åˆ›å»ºç¼“å­˜ç›®å½• `.cache/crops/`
2. è®¡ç®—å›¾åƒçš„ MD5 å“ˆå¸Œï¼ˆå‰ 10 ä½ï¼‰
3. ä¿å­˜è£å‰ªåçš„é¢„è§ˆå›¾åƒ
4. è¿”å›æ–‡ä»¶è·¯å¾„

**ä¼˜åŠ¿**:
- MD5 å“ˆå¸Œç¡®ä¿ç›¸åŒå›¾åƒä½¿ç”¨ç›¸åŒæ–‡ä»¶å
- è‡ªåŠ¨ç¼“å­˜ï¼Œé¿å…é‡å¤ä¿å­˜
- çŸ­å“ˆå¸Œï¼ˆ10 ä½ï¼‰å‡å°‘æ–‡ä»¶åé•¿åº¦

### 3. API è°ƒç”¨ (Line 113-114)

```python
with st.spinner("è¯†åˆ«ä¸­â€¦"):
    res = analyze_image(patch_path, engine=engine, lang=lang)
```

**å‚æ•°**:
- `patch_path`: è£å‰ªå›¾åƒçš„æ–‡ä»¶è·¯å¾„
- `engine`: ç”¨æˆ·é€‰æ‹©çš„å¼•æ“ï¼ˆ`cloud_qwen`, `cloud_gpt4o`, `cloud_gemini`ï¼‰
- `lang`: è¯­è¨€è®¾ç½®ï¼ˆ`zh` æˆ– `en`ï¼‰

**è¿”å›æ ¼å¼**:
```python
{
    "materials": ["çš®é©", "ç¼é¢", "æ¶¤çº¶"],
    "confidence": [0.6, 0.25, 0.15],
    "description": "LLM ç”Ÿæˆçš„è¯¦ç»†è§£é‡Š...",
    "engine": "cloud_qwen",
    "cache_key": "md5_hash"
}
```

### 4. å¼•æ“æ˜¾ç¤º (Line 117)

```python
st.caption(f"Engine: {engine}")
```

**æ˜¾ç¤ºç¤ºä¾‹**:
- `Engine: cloud_qwen`
- `Engine: cloud_gpt4o`
- `Engine: cloud_gemini`

### 5. Top-3 æè´¨æ¸²æŸ“ (Line 119-128)

```python
# Display Top-3 materials with confidence bars
mats = res.get("materials", [])
confs = res.get("confidence", [])
if mats:
    for i, name in enumerate(mats[:3]):
        score = confs[i] if i < len(confs) else 0.0
        st.write(f"**{i+1}. {name.upper()}**")
        st.progress(min(max(float(score), 0.0), 1.0))
else:
    st.info("æœªä»æè¿°ä¸­æŠ½å–åˆ°æ˜ç¡®çš„é¢æ–™åç§°ï¼Œå·²å±•ç¤ºåŸå§‹è§£é‡Šã€‚")
```

**æ˜¾ç¤ºæ•ˆæœ**:
```
Engine: cloud_qwen

**1. çš®é©**
â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘ 60%

**2. ç¼é¢**
â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘ 25%

**3. æ¶¤çº¶**
â–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘ 15%
```

**ç‰¹æ€§**:
- æè´¨åç§°å¤§å†™åŠ ç²—ï¼ˆ`name.upper()`ï¼‰
- ç½®ä¿¡åº¦è¿›åº¦æ¡å¯è§†åŒ–
- è‡ªåŠ¨å¤„ç†ç¼ºå¤±å€¼ï¼ˆé»˜è®¤ 0.0ï¼‰
- ç½®ä¿¡åº¦é™åˆ¶åœ¨ [0.0, 1.0] èŒƒå›´å†…

### 6. æ¨ç†æ–‡æœ¬ (Line 130-133)

```python
# Display reasoning/description
if res.get("description"):
    with st.expander("ğŸ’¡ è§£é‡Š / Reasoning", expanded=False):
        st.write(res["description"])
```

**ç‰¹æ€§**:
- å¯æŠ˜å å±•ç¤ºï¼ˆ`expanded=False`ï¼‰
- å¸¦å›¾æ ‡æ ‡é¢˜ï¼ˆğŸ’¡ï¼‰
- åŒè¯­æ ‡é¢˜
- ä»…åœ¨æœ‰æè¿°æ—¶æ˜¾ç¤º

### 7. é”™è¯¯å¤„ç† (Line 135-138)

```python
except NoAPIKeyError:
    st.error("æœªæ£€æµ‹åˆ° DASHSCOPE_API_KEYï¼Œè¯·åœ¨ .streamlit/secrets.toml æˆ–äº‘ç«¯ Secrets ä¸­é…ç½®ã€‚")
except Exception as e:
    st.error(f"äº‘ç«¯åˆ†æå¤±è´¥ï¼š{e}")
```

**é”™è¯¯ç±»å‹**:
1. **NoAPIKeyError**: ç¼ºå°‘ API Key
   - æ˜¾ç¤ºé…ç½®æç¤º
   - å¼•å¯¼ç”¨æˆ·é…ç½® secrets

2. **Exception**: å…¶ä»–é”™è¯¯
   - æ˜¾ç¤ºå…·ä½“é”™è¯¯ä¿¡æ¯
   - å¸®åŠ©è°ƒè¯•é—®é¢˜

## ğŸ“Š æ•°æ®æµ

### å®Œæ•´æµç¨‹

```
ç”¨æˆ·ç‚¹å‡»"è¯†åˆ«è¯¥åŒºåŸŸ"æŒ‰é’®
  â†“
åˆ›å»ºç¼“å­˜ç›®å½•
  â†“
è®¡ç®—å›¾åƒ MD5 å“ˆå¸Œ
  â†“
ä¿å­˜è£å‰ªå›¾åƒåˆ° .cache/crops/
  â†“
æ˜¾ç¤º spinner "è¯†åˆ«ä¸­â€¦"
  â†“
è°ƒç”¨ analyze_image(
    patch_path,
    engine=engine,  â† ç”¨æˆ·é€‰æ‹©çš„å¼•æ“
    lang=lang       â† ç”¨æˆ·é€‰æ‹©çš„è¯­è¨€
)
  â†“
è§£æè¿”å›ç»“æœ
  â†“
æ˜¾ç¤ºå¼•æ“ ID
  â†“
æ¸²æŸ“ Top-3 æè´¨ + ç½®ä¿¡åº¦æ¡
  â†“
æ˜¾ç¤ºæ¨ç†æ–‡æœ¬ï¼ˆå¯æŠ˜å ï¼‰
  â†“
å®Œæˆ
```

### é”™è¯¯å¤„ç†æµç¨‹

```
try:
    ä¿å­˜å›¾åƒ
    â†“
    è°ƒç”¨ API
    â†“
    æ¸²æŸ“ç»“æœ
except NoAPIKeyError:
    â†“
    æ˜¾ç¤º API Key é…ç½®æç¤º
except Exception:
    â†“
    æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
```

## ğŸ¨ UI ç¤ºä¾‹

### æˆåŠŸè¯†åˆ«

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ é¢„è§ˆä¸è¯†åˆ«                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ [é¢„è§ˆå›¾åƒ]                  â”‚
â”‚ 160Ã—160 px                  â”‚
â”‚                             â”‚
â”‚ [ğŸš€ è¯†åˆ«è¯¥åŒºåŸŸ]             â”‚
â”‚                             â”‚
â”‚ Engine: cloud_qwen          â”‚
â”‚                             â”‚
â”‚ **1. çš®é©**                 â”‚
â”‚ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘ 60%   â”‚
â”‚                             â”‚
â”‚ **2. ç¼é¢**                 â”‚
â”‚ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘ 25%   â”‚
â”‚                             â”‚
â”‚ **3. æ¶¤çº¶**                 â”‚
â”‚ â–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘ 15%   â”‚
â”‚                             â”‚
â”‚ ğŸ’¡ è§£é‡Š / Reasoning â–¼       â”‚
â”‚ â””â”€ LLM ç”Ÿæˆçš„è¯¦ç»†è§£é‡Š...    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### API Key é”™è¯¯

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ âŒ æœªæ£€æµ‹åˆ° DASHSCOPE_API_KEYâ”‚
â”‚                             â”‚
â”‚ è¯·åœ¨ .streamlit/secrets.tomlâ”‚
â”‚ æˆ–äº‘ç«¯ Secrets ä¸­é…ç½®ã€‚      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ç½‘ç»œé”™è¯¯

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ âŒ äº‘ç«¯åˆ†æå¤±è´¥ï¼š            â”‚
â”‚ Connection timeout          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”§ é…ç½®å‚æ•°

### ç¼“å­˜ç›®å½•

| å‚æ•° | å€¼ | è¯´æ˜ |
|------|-----|------|
| ç›®å½• | `.cache/crops/` | è£å‰ªå›¾åƒç¼“å­˜ |
| æ–‡ä»¶å | `{md5[:10]}.png` | MD5 å“ˆå¸Œå‰ 10 ä½ |
| æ ¼å¼ | PNG | æ— æŸå‹ç¼© |

### æ˜¾ç¤ºå‚æ•°

| å‚æ•° | å€¼ | è¯´æ˜ |
|------|-----|------|
| Top-N | 3 | æ˜¾ç¤ºå‰ 3 ä¸ªæè´¨ |
| ç½®ä¿¡åº¦èŒƒå›´ | [0.0, 1.0] | è¿›åº¦æ¡èŒƒå›´ |
| æè´¨æ ¼å¼ | å¤§å†™åŠ ç²— | `**{name.upper()}**` |
| æ¨ç†å±•å¼€ | False | é»˜è®¤æŠ˜å  |

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–

### 1. MD5 ç¼“å­˜

```python
key = md5(preview.tobytes()).hexdigest()[:10]
```

**ä¼˜åŠ¿**:
- ç›¸åŒå›¾åƒä½¿ç”¨ç›¸åŒæ–‡ä»¶å
- é¿å…é‡å¤ä¿å­˜
- æ”¯æŒ API å±‚é¢çš„ç¼“å­˜

### 2. é”™è¯¯å¤„ç†

```python
try:
    # API è°ƒç”¨
except NoAPIKeyError:
    # ç‰¹å®šé”™è¯¯å¤„ç†
except Exception as e:
    # é€šç”¨é”™è¯¯å¤„ç†
```

**ä¼˜åŠ¿**:
- åŒºåˆ†ä¸åŒé”™è¯¯ç±»å‹
- æä¾›é’ˆå¯¹æ€§æç¤º
- é¿å…åº”ç”¨å´©æºƒ

### 3. ç½®ä¿¡åº¦å®‰å…¨å¤„ç†

```python
score = confs[i] if i < len(confs) else 0.0
st.progress(min(max(float(score), 0.0), 1.0))
```

**ä¼˜åŠ¿**:
- å¤„ç†ç¼ºå¤±å€¼
- é™åˆ¶èŒƒå›´ [0.0, 1.0]
- é¿å…è¿›åº¦æ¡é”™è¯¯

## âœ… éªŒæ”¶æ¸…å•

### åŠŸèƒ½éªŒæ”¶

- [x] æŒ‰é’®ç‚¹å‡»è§¦å‘è¯†åˆ«
- [x] å›¾åƒä¿å­˜åˆ°ç¼“å­˜ç›®å½•
- [x] ä½¿ç”¨ç”¨æˆ·é€‰æ‹©çš„å¼•æ“
- [x] ä¼ é€’è¯­è¨€å‚æ•°
- [x] æ˜¾ç¤ºå¼•æ“ ID
- [x] æ¸²æŸ“ Top-3 æè´¨
- [x] æ˜¾ç¤ºç½®ä¿¡åº¦è¿›åº¦æ¡
- [x] æ˜¾ç¤ºæ¨ç†æ–‡æœ¬ï¼ˆå¯æŠ˜å ï¼‰
- [x] å¤„ç† NoAPIKeyError
- [x] å¤„ç†é€šç”¨å¼‚å¸¸

### ä»£ç è´¨é‡

- [x] è¯­æ³•æ­£ç¡®
- [x] æ³¨é‡Šæ¸…æ™°
- [x] é”™è¯¯å¤„ç†å®Œå–„
- [x] æ•°æ®éªŒè¯å……åˆ†
- [x] UI å“åº”å‹å¥½

### ç”¨æˆ·ä½“éªŒ

- [x] æŒ‰é’®å æ»¡å®½åº¦
- [x] Spinner æ˜¾ç¤ºåŠ è½½çŠ¶æ€
- [x] æè´¨åç§°æ¸…æ™°ï¼ˆå¤§å†™åŠ ç²—ï¼‰
- [x] ç½®ä¿¡åº¦å¯è§†åŒ–
- [x] æ¨ç†æ–‡æœ¬å¯æŠ˜å 
- [x] é”™è¯¯æç¤ºå‹å¥½

## ğŸš€ åç»­ä¼˜åŒ–

### å¯èƒ½çš„æ”¹è¿›

1. **æ·»åŠ è¯†åˆ«æ—¶é—´æ˜¾ç¤º**
   ```python
   import time
   t0 = time.time()
   res = analyze_image(...)
   elapsed = time.time() - t0
   st.caption(f"è¯†åˆ«è€—æ—¶: {elapsed:.2f}s")
   ```

2. **æ·»åŠ ç»“æœç¼“å­˜æç¤º**
   ```python
   if res.get("cache_key"):
       st.caption("âœ“ ä½¿ç”¨ç¼“å­˜ç»“æœ")
   ```

3. **æ·»åŠ æè´¨è¯¦æƒ…é“¾æ¥**
   ```python
   st.write(f"**{i+1}. [{name.upper()}](https://example.com/fabric/{name})**")
   ```

4. **æ·»åŠ ç»“æœå¯¼å‡ºåŠŸèƒ½**
   ```python
   if st.button("å¯¼å‡ºç»“æœ"):
       json.dump(res, open("result.json", "w"))
   ```

## ğŸ‰ æ€»ç»“

è¯†åˆ«æŒ‰é’®åŠŸèƒ½å·²å®Œæ•´å®ç°ï¼š
- âœ… **åŠ¨æ€å¼•æ“**: ä½¿ç”¨ç”¨æˆ·é€‰æ‹©çš„æ¨¡å‹
- âœ… **å®Œæ•´æµç¨‹**: ä¿å­˜ â†’ è°ƒç”¨ â†’ æ¸²æŸ“
- âœ… **å¯è§†åŒ–**: Top-3 + ç½®ä¿¡åº¦æ¡ + æ¨ç†
- âœ… **é”™è¯¯å¤„ç†**: å‹å¥½çš„é”™è¯¯æç¤º
- âœ… **æ€§èƒ½ä¼˜åŒ–**: MD5 ç¼“å­˜ + å®‰å…¨å¤„ç†

ç”¨æˆ·ç°åœ¨å¯ä»¥æµç•…åœ°è¯†åˆ«é¢æ–™ï¼Œè·å¾—æ¸…æ™°çš„åˆ†æç»“æœï¼

---

**æ›´æ–°æ—¶é—´**: 2025-10-24  
**ç‰ˆæœ¬**: 6.3 (Recognition Button)  
**çŠ¶æ€**: âœ… å®Œæˆå¹¶éªŒè¯é€šè¿‡

