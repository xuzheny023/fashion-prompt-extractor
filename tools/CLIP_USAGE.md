# CLIP æ£€ç´¢ç³»ç»Ÿä½¿ç”¨æŒ‡å—

## ğŸ“‹ å¿«é€Ÿå¼€å§‹

### 1ï¸âƒ£ å‡†å¤‡å‚è€ƒå›¾åƒåº“

å°†é¢æ–™å‚è€ƒå›¾åƒæŒ‰ä»¥ä¸‹ç»“æ„ç»„ç»‡ï¼š

```
data/fabrics/
â”œâ”€â”€ cotton/
â”‚   â”œâ”€â”€ ref1.jpg
â”‚   â”œâ”€â”€ ref2.jpg
â”‚   â””â”€â”€ ref3.png
â”œâ”€â”€ silk_satin/
â”‚   â”œâ”€â”€ sample1.jpg
â”‚   â””â”€â”€ sample2.jpeg
â”œâ”€â”€ wool/
â”‚   â””â”€â”€ reference.jpg
â””â”€â”€ ...
```

**è¦æ±‚ï¼š**
- æ¯ä¸ªé¢æ–™è‡³å°‘ 3-5 å¼ å‚è€ƒå›¾åƒ
- å›¾åƒæ ¼å¼ï¼šJPGã€JPEGã€PNG
- å»ºè®®åˆ†è¾¨ç‡ï¼š224x224 ä»¥ä¸Š
- è´¨é‡ä¼˜å…ˆäºæ•°é‡

### 2ï¸âƒ£ æ„å»ºé¢æ–™å‘é‡åº“

```bash
venv\Scripts\python.exe tools\build_fabric_bank.py
```

**è¾“å‡ºï¼š**
- `data/fabric_bank.npz` - å‹ç¼©çš„ CLIP åµŒå…¥å‘é‡åº“

**é¢„æœŸè¾“å‡ºç¤ºä¾‹ï¼š**
```
Building fabric reference bank...

  [cotton] Processed: ref1.jpg
  [cotton] Processed: ref2.jpg
[OK] cotton: 2 images -> shape (2, 512)
...

============================================================
âœ… Saved fabric bank -> D:\...\data\fabric_bank.npz
   Total fabrics: 5
   Total images: 15
   File size: 18.3 KB
============================================================
```

### 3ï¸âƒ£ ï¼ˆå¯é€‰ï¼‰è®­ç»ƒçº¿æ€§åˆ†ç±»å¤´

å¦‚æœæœ‰å·²æ ‡æ³¨çš„ patch æ•°æ®ï¼Œå¯ä»¥è®­ç»ƒçº¿æ€§å¤´æå‡å‡†ç¡®ç‡ï¼š

```bash
venv\Scripts\python.exe tools\clip_train.py
```

**æ•°æ®å‡†å¤‡ï¼š**
```
data/patches/labeled/
â”œâ”€â”€ cotton/
â”‚   â”œâ”€â”€ patch1.jpg
â”‚   â””â”€â”€ patch2.png
â”œâ”€â”€ silk/
â”‚   â””â”€â”€ patch1.jpg
â””â”€â”€ ...
```

**è¾“å‡ºï¼š**
- `data/clip_model.pkl` - è®­ç»ƒå¥½çš„ LogisticRegression æ¨¡å‹

**è¦æ±‚ï¼š**
- æ¯ä¸ªç±»åˆ«è‡³å°‘ 5-10 ä¸ªæ ‡æ³¨æ ·æœ¬
- æ€»æ ·æœ¬æ•°å»ºè®® > 20

### 4ï¸âƒ£ è¯„ä¼°æ€§èƒ½

```bash
venv\Scripts\python.exe tools\eval_quick.py
```

**åŠŸèƒ½ï¼š**
1. è¯„ä¼° CLIP æ£€ç´¢çš„ Top-1 å’Œ Top-K å‡†ç¡®ç‡
2. æ˜¾ç¤ºæ··æ·†çŸ©é˜µ
3. è¯„ä¼°çº¿æ€§åˆ†ç±»å¤´æ€§èƒ½ï¼ˆå¦‚æœå­˜åœ¨ï¼‰

**è¾“å‡ºç¤ºä¾‹ï¼š**
```
============================================================
Overall Metrics
============================================================
Total samples: 35
Top-1 Accuracy: 85.71% (30/35)
Top-5 Accuracy: 97.14% (34/35)

============================================================
Per-Class Metrics
============================================================
Class                Samples    Top-1 Acc    Top-5 Acc
------------------------------------------------------------
cotton               15         93.33%       100.00%
silk                 8          75.00%       87.50%
wool                 12         83.33%       100.00%
```

---

## ğŸ”§ åœ¨ä»£ç ä¸­ä½¿ç”¨

### æ–¹å¼ 1ï¼šçº¯ CLIP æ£€ç´¢

```python
from PIL import Image
from src.clip_infer import rank_by_retrieval

# åŠ è½½ patch å›¾åƒ
patch_img = Image.open("path/to/patch.jpg")

# æ£€ç´¢ Top-5 ç›¸ä¼¼é¢æ–™
results = rank_by_retrieval(patch_img, topk=5)

# ç»“æœæ ¼å¼: [{"id": "cotton", "score": 0.856}, ...]
for r in results:
    print(f"{r['id']}: {r['score']:.3f}")
```

### æ–¹å¼ 2ï¼šèåˆè§„åˆ™ + CLIPï¼ˆæ¨èï¼‰

```python
from PIL import Image
from src.fabric_ranker import recommend_fabrics_localized, fuse_with_clip

# 1. æå–å±æ€§ï¼ˆå‡è®¾å·²å®Œæˆï¼‰
attrs = {
    "visual": {
        "dominant_color_name": "blue",
        "sheen_score": 0.6,
        "texture_complexity": 0.4
    }
}

# 2. åŸºäºè§„åˆ™çš„æ¨è
base_results = recommend_fabrics_localized(
    attrs, 
    lang="zh", 
    top_k=10,
    rules_source="fine"
)

# 3. èåˆ CLIP æ£€ç´¢
patch_img = Image.open("path/to/patch.jpg")
fused_results = fuse_with_clip(
    patch_img=patch_img,
    base_results=base_results,
    lang="zh",
    alpha=0.7,  # 0.7 è§„åˆ™ + 0.3 CLIP
    topk=5
)

# 4. æ˜¾ç¤ºç»“æœ
for name, score, display_name, notes in fused_results:
    print(f"{display_name}: {score:.3f}")
```

---

## ğŸ›ï¸ å‚æ•°è°ƒä¼˜

### `alpha` æƒé‡ï¼ˆèåˆæ—¶ï¼‰

- **alpha=1.0**: å®Œå…¨åŸºäºè§„åˆ™ï¼ˆå¿½ç•¥ CLIPï¼‰
- **alpha=0.7**: æ¨èå€¼ - å¹³è¡¡è§„åˆ™ä¸è§†è§‰ç›¸ä¼¼åº¦
- **alpha=0.5**: è§„åˆ™ä¸ CLIP å‡ç­‰æƒé‡
- **alpha=0.0**: å®Œå…¨åŸºäº CLIP æ£€ç´¢

**å»ºè®®ï¼š**
- è§„åˆ™åº“å®Œå–„æ—¶ï¼š`alpha=0.7-0.8`
- è§„åˆ™åº“ä¸å…¨æ—¶ï¼š`alpha=0.3-0.5`
- çº¯è§†è§‰æ£€ç´¢ï¼š`alpha=0.0`

### Top-K æ•°é‡

- **topk=3**: ä»…æ˜¾ç¤ºæœ€ç›¸ä¼¼çš„ 3 ä¸ªé¢æ–™
- **topk=5**: æ¨èå€¼ - å¹³è¡¡å¤šæ ·æ€§ä¸å‡†ç¡®ç‡
- **topk=10**: æä¾›æ›´å¤šå€™é€‰ï¼Œé€‚åˆæ¢ç´¢

---

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–å»ºè®®

### 1. æå‡å‚è€ƒåº“è´¨é‡
- âœ… æ¯ä¸ªé¢æ–™æ”¶é›†å¤šè§’åº¦ã€å¤šå…‰ç…§çš„å‚è€ƒå›¾
- âœ… å‚è€ƒå›¾åº”è¦†ç›–å…¸å‹çº¹ç†å’Œé¢œè‰²å˜åŒ–
- âœ… é¿å…è¿‡åº¦æ›å…‰æˆ–æ¨¡ç³Šçš„å›¾åƒ

### 2. æ ‡æ³¨æ•°æ®ç§¯ç´¯
- âœ… ä»ä½ç½®ä¿¡åº¦çš„ patch å¼€å§‹æ ‡æ³¨
- âœ… å…³æ³¨æ˜“æ··æ·†çš„é¢æ–™å¯¹ï¼ˆå¦‚ silk vs satinï¼‰
- âœ… æ¯å‘¨å¢é‡è®­ç»ƒæ›´æ–°æ¨¡å‹

### 3. æ¨¡å‹é€‰æ‹©
å½“å‰ä½¿ç”¨ `ViT-B-32`ï¼ˆå¿«é€Ÿï¼Œä¸­ç­‰ç²¾åº¦ï¼‰

**å¯å‡çº§åˆ°ï¼š**
- `ViT-B-16`: æ›´é«˜ç²¾åº¦ï¼Œç¨æ…¢
- `ViT-L-14`: æœ€é«˜ç²¾åº¦ï¼Œè¾ƒæ…¢

ä¿®æ”¹ `src/clip_infer.py` ç¬¬ 25 è¡Œï¼š
```python
_model, _, _preprocess = create_model_and_transforms("ViT-L-14", pretrained="openai")
```

---

## ğŸ› å¸¸è§é—®é¢˜

### Q1: "No embeddings collected"
**åŸå› ï¼š** `data/fabrics/` ä¸ºç©ºæˆ–ç»“æ„ä¸æ­£ç¡®

**è§£å†³ï¼š**
```bash
# æ£€æŸ¥ç›®å½•ç»“æ„
ls data/fabrics/

# åº”è¯¥æœ‰å­ç›®å½•ï¼š
data/fabrics/cotton/ref1.jpg
data/fabrics/silk/ref1.jpg
```

### Q2: "Too few samples to train"
**åŸå› ï¼š** æ ‡æ³¨æ•°æ®å°‘äº 20 ä¸ª

**è§£å†³ï¼š**
- å…ˆä½¿ç”¨çº¯æ£€ç´¢æ¨¡å¼ï¼ˆä¸è®­ç»ƒçº¿æ€§å¤´ï¼‰
- æŒç»­ç§¯ç´¯æ ‡æ³¨æ•°æ®åˆ° 50+ å†è®­ç»ƒ

### Q3: CLIP æ£€ç´¢é€Ÿåº¦æ…¢
**åŸå› ï¼š** æ¯æ¬¡éƒ½é‡æ–°åŠ è½½æ¨¡å‹

**è§£å†³ï¼š**
- æ¨¡å‹å·²å®ç°æ‡’åŠ è½½ï¼ˆé¦–æ¬¡æ…¢ï¼Œåç»­å¿«ï¼‰
- å¦‚éœ€è¿›ä¸€æ­¥ä¼˜åŒ–ï¼Œè€ƒè™‘é¢„å…ˆæå– patch åµŒå…¥å¹¶ç¼“å­˜

### Q4: èåˆåç»“æœåè€Œå˜å·®
**åŸå› ï¼š** `alpha` æƒé‡ä¸åˆé€‚æˆ–å‚è€ƒåº“è´¨é‡é—®é¢˜

**è§£å†³ï¼š**
1. æ£€æŸ¥å‚è€ƒåº“æ˜¯å¦åŒ…å«è¯¥é¢æ–™
2. è°ƒæ•´ `alpha` æƒé‡ï¼ˆå¢å¤§ alpha é™ä½ CLIP å½±å“ï¼‰
3. å¢åŠ æ›´å¤šé«˜è´¨é‡å‚è€ƒå›¾

---

## ğŸ“ˆ æ•ˆæœé¢„æœŸ

**åœ¨å…¸å‹åœºæ™¯ä¸‹ï¼ˆ50+ é¢æ–™ç±»åˆ«ï¼Œæ¯ç±» 5 å¼ å‚è€ƒå›¾ï¼‰ï¼š**

| æŒ‡æ ‡ | çº¯è§„åˆ™ | +CLIP æ£€ç´¢ | +çº¿æ€§å¤´ |
|------|--------|-----------|---------|
| Top-1 å‡†ç¡®ç‡ | 60-70% | 75-85% | 85-92% |
| Top-5 å‡†ç¡®ç‡ | 85-90% | 92-96% | 96-98% |
| å¤„ç†é€Ÿåº¦ | æå¿« | å¿« | å¿« |
| å†·å¯åŠ¨æ—¶é—´ | 0s | 2-3s | 2-3s |

**å»ºè®®è¿­ä»£è·¯å¾„ï¼š**
1. ğŸš€ **Phase 1**: çº¯è§„åˆ™ç³»ç»Ÿï¼ˆå½“å‰ï¼‰
2. ğŸ¯ **Phase 2**: +CLIP æ£€ç´¢èåˆï¼ˆæœ¬æ¬¡æ›´æ–°ï¼‰
3. ğŸ“Š **Phase 3**: +æ ‡æ³¨æ•°æ® + çº¿æ€§å¤´è®­ç»ƒ
4. ğŸ† **Phase 4**: å¾®è°ƒ CLIP æˆ–æ›´å¤§æ¨¡å‹

---

## ğŸ”— ç›¸å…³æ–‡ä»¶

- `src/clip_infer.py` - CLIP æ¨ç†æ ¸å¿ƒæ¨¡å—
- `src/fabric_ranker.py` - èåˆé€»è¾‘ï¼ˆ`fuse_with_clip` å‡½æ•°ï¼‰
- `tools/build_fabric_bank.py` - æ„å»ºå‚è€ƒåº“è„šæœ¬
- `tools/clip_train.py` - è®­ç»ƒçº¿æ€§å¤´è„šæœ¬
- `tools/eval_quick.py` - è¯„ä¼°è„šæœ¬

---

**æœ€åæ›´æ–°:** 2025-10-09  
**ç»´æŠ¤è€…:** Fashion Prompt Extractor Team

