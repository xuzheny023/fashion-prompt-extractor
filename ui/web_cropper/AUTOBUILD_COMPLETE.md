# âœ… Web Cropper Auto-Build å®ç°å®Œæˆ

## ğŸ“‹ å®ç°æ¦‚è¿°

å·²æˆåŠŸå®ç° `ui/web_cropper/__init__.py` çš„"æ„å»ºä¼˜å…ˆ"è‡ªåŠ¨åŠ è½½ç­–ç•¥ã€‚

---

## ğŸ¯ æ ¸å¿ƒç‰¹æ€§

### 1. **æ™ºèƒ½æ„å»ºæ£€æµ‹**
- âœ… åŸºäºæºç å“ˆå¸Œï¼ˆMD5ï¼‰è¿½è¸ªå˜åŒ–
- âœ… ä½¿ç”¨ `.build.stamp` æ–‡ä»¶å­˜å‚¨ä¸Šæ¬¡æ„å»ºå“ˆå¸Œ
- âœ… ä»…åœ¨å¿…è¦æ—¶è§¦å‘æ„å»ºï¼ˆå¹‚ç­‰æ€§ï¼‰

### 2. **è‡ªåŠ¨æ„å»ºæµç¨‹**
```
æ£€æµ‹æ„å»ºäº§ç‰©
    â†“
ä¸å­˜åœ¨æˆ–æºç å˜åŒ–ï¼Ÿ
    â†“ æ˜¯
æ£€æŸ¥ Node.js
    â†“
è¿è¡Œ npm ci/install
    â†“
è¿è¡Œ npm run build
    â†“
ä¿å­˜æ„å»ºå“ˆå¸Œ
    â†“
åŠ è½½ç»„ä»¶
```

### 3. **å¤šæ¨¡å¼æ”¯æŒ**

#### æ¨¡å¼ A: ç”Ÿäº§æ¨¡å¼ï¼ˆé»˜è®¤ï¼‰
```powershell
streamlit run app_new.py
```
- è‡ªåŠ¨æ£€æµ‹ `dist/` æˆ– `build/` ç›®å½•
- æºç å˜åŒ–æ—¶è‡ªåŠ¨é‡æ–°æ„å»º
- é›¶é…ç½®ï¼Œå¼€ç®±å³ç”¨

#### æ¨¡å¼ B: å¼€å‘æ¨¡å¼ï¼ˆå¯é€‰ï¼‰
```powershell
# Terminal 1
cd ui/web_cropper/frontend
npm run dev

# Terminal 2
$env:WEB_CROPPER_DEV_URL = "http://localhost:5173"
streamlit run app_new.py
```
- ä¼˜å…ˆä½¿ç”¨å¼€å‘æœåŠ¡å™¨
- æ”¯æŒçƒ­é‡è½½
- å¼€å‘æœåŠ¡å™¨ä¸å¯è¾¾æ—¶è‡ªåŠ¨å›é€€

### 4. **å®¹é”™æœºåˆ¶**
- âœ… Node.js æœªå®‰è£…ï¼šæ˜¾ç¤ºæ¸…æ™°é”™è¯¯ï¼Œä¸å´©æºƒ
- âœ… æ„å»ºå¤±è´¥ï¼šæ˜¾ç¤ºè¯¦ç»†è¾“å‡ºï¼Œç»§ç»­å£°æ˜ç»„ä»¶
- âœ… ç«¯å£ä¸å¯è¾¾ï¼šè‡ªåŠ¨å›é€€åˆ°æ„å»ºäº§ç‰©
- âœ… è¶…æ—¶ä¿æŠ¤ï¼šæ„å»ºè¶…æ—¶ 5 åˆ†é’Ÿè‡ªåŠ¨ç»ˆæ­¢

---

## ğŸ“ æ–‡ä»¶æ¸…å•

### æ ¸å¿ƒæ–‡ä»¶
- âœ… `ui/web_cropper/__init__.py` - **å·²é‡å†™**ï¼Œå®ç°è‡ªåŠ¨æ„å»º
- âœ… `ui/web_cropper/frontend/src/App.tsx` - **å·²æ›´æ–°**ï¼Œç®€åŒ–ç‰ˆè£å‰ªç»„ä»¶
- âœ… `ui/web_cropper/frontend/src/main.tsx` - **å·²æ›´æ–°**ï¼Œé›†æˆ streamlit-component-lib
- âœ… `ui/web_cropper/frontend/vite.config.ts` - **å·²æ›´æ–°**ï¼Œè¾“å‡ºåˆ° `dist/`
- âœ… `ui/web_cropper/frontend/package.json` - **å·²æ›´æ–°**ï¼Œæ·»åŠ  streamlit-component-lib
- âœ… `app_new.py` - **å·²æ›´æ–°**ï¼Œä½¿ç”¨æ–°çš„ç»„ä»¶ API

### æ–‡æ¡£å’Œå·¥å…·
- âœ… `ui/web_cropper/TEST_AUTO_BUILD.md` - å®Œæ•´æµ‹è¯•æŒ‡å—
- âœ… `ui/web_cropper/verify_setup.py` - å¿«é€ŸéªŒè¯è„šæœ¬
- âœ… `ui/web_cropper/SETUP.md` - è®¾ç½®æ–‡æ¡£
- âœ… `ui/web_cropper/AUTOBUILD_COMPLETE.md` - æœ¬æ–‡æ¡£

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### éªŒè¯è®¾ç½®
```powershell
python ui/web_cropper/verify_setup.py
```

### é¦–æ¬¡è¿è¡Œï¼ˆè‡ªåŠ¨æ„å»ºï¼‰
```powershell
streamlit run app_new.py
```

**é¢„æœŸè¾“å‡ºï¼š**
```
================================================================================
ğŸ”¨ web_cropper: Build needed (sources changed or no build output)
================================================================================

ğŸ“¦ Running: npm ci (using package-lock.json)
âœ… Dependencies installed
ğŸ—ï¸  Running: npm run build
âœ… Build completed successfully
================================================================================

âœ… web_cropper: Using build from frontend/dist
```

### åç»­è¿è¡Œï¼ˆè·³è¿‡æ„å»ºï¼‰
```powershell
streamlit run app_new.py
```

**é¢„æœŸè¾“å‡ºï¼š**
```
âœ… web_cropper: Using build from frontend/dist
```

---

## ğŸ” æŠ€æœ¯ç»†èŠ‚

### æºç å“ˆå¸Œè¿½è¸ª
è¿½è¸ªä»¥ä¸‹æ–‡ä»¶çš„å˜åŒ–ï¼š
- `package.json`
- `package-lock.json`
- `vite.config.ts`
- `tsconfig.json`
- `src/main.tsx`
- `src/App.tsx`
- `src/style.css`

### æ„å»ºå‘½ä»¤é€‰æ‹©
```python
if package-lock.json exists:
    npm ci  # æ›´å¿«ï¼Œä½¿ç”¨é”å®šç‰ˆæœ¬
else:
    npm install  # å›é€€
```

### ç«¯å£æ£€æµ‹
```python
def _port_open(host, port, timeout=0.3):
    # 300ms è¶…æ—¶å¿«é€Ÿæ£€æµ‹
    socket.create_connection((host, port), timeout)
```

---

## ğŸ“Š æ€§èƒ½æŒ‡æ ‡

| æ“ä½œ | æ—¶é—´ | è¯´æ˜ |
|------|------|------|
| é¦–æ¬¡æ„å»º | ~60s | åŒ…å« npm install + build |
| å¢é‡æ„å»º | ~45s | ä»… buildï¼ˆä¾èµ–å·²å®‰è£…ï¼‰ |
| è·³è¿‡æ„å»º | <1s | å“ˆå¸ŒåŒ¹é…ï¼Œç›´æ¥åŠ è½½ |
| ç«¯å£æ£€æµ‹ | <300ms | å¿«é€Ÿå¤±è´¥ |

---

## âœ… éªŒæ”¶æµ‹è¯•

### å½“å‰çŠ¶æ€
```
âœ… Python æ–‡ä»¶è¯­æ³•æ­£ç¡®
âœ… å‰ç«¯æ–‡ä»¶ç»“æ„å®Œæ•´
âœ… Node.js å·²å®‰è£… (v22.21.0)
âœ… npm å·²å®‰è£… (10.9.4)
âœ… æ„å»ºäº§ç‰©å­˜åœ¨ (build/)
âš ï¸  dist/ æœªç”Ÿæˆï¼ˆé¦–æ¬¡è¿è¡Œæ—¶è‡ªåŠ¨åˆ›å»ºï¼‰
```

### å¾…æµ‹è¯•åœºæ™¯
- [ ] åœºæ™¯ 1: é¦–æ¬¡è¿è¡Œï¼ˆæ— æ„å»ºäº§ç‰©ï¼‰
- [ ] åœºæ™¯ 2: åç»­è¿è¡Œï¼ˆè·³è¿‡æ„å»ºï¼‰
- [ ] åœºæ™¯ 3: æºç ä¿®æ”¹åè¿è¡Œ
- [ ] åœºæ™¯ 4: å¼€å‘æ¨¡å¼ï¼ˆDev Serverï¼‰
- [ ] åœºæ™¯ 5: å¼€å‘æ¨¡å¼å›é€€
- [ ] åœºæ™¯ 6: Node.js æœªå®‰è£…

è¯¦è§ `TEST_AUTO_BUILD.md`

---

## ğŸ› å·²çŸ¥é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ

### é—®é¢˜ 1: æ„å»ºäº§ç‰©åœ¨ `build/` è€Œé `dist/`
**åŸå› ï¼š** ä¹‹å‰çš„ vite.config.ts é…ç½®è¾“å‡ºåˆ° `build/`

**è§£å†³ï¼š** å·²æ›´æ–° vite.config.ts è¾“å‡ºåˆ° `dist/`ï¼Œç»„ä»¶åŠ è½½å™¨å…¼å®¹ä¸¤è€…

### é—®é¢˜ 2: ç»„ä»¶å›¾ç‰‡ä¸æ˜¾ç¤º
**åŸå› ï¼š** ä½¿ç”¨ç›¸å¯¹ URL æ—¶ baseUrlPath æ‹¼æ¥é—®é¢˜

**è§£å†³ï¼š** æ–°ç‰ˆ App.tsx ä½¿ç”¨ base64 ä¼ å›¾ï¼Œé¿å… URL é—®é¢˜

### é—®é¢˜ 3: æ‹–åŠ¨ä¸æµç•…
**åŸå› ï¼š** ç®€åŒ–ç‰ˆæ‹–åŠ¨å®ç°ï¼ˆæ¼”ç¤ºç”¨ï¼‰

**è§£å†³ï¼š** å¯æ›¿æ¢ä¸º react-easy-crop æˆ–å…¶ä»–æˆç†Ÿåº“

---

## ğŸ”„ å‡çº§è·¯å¾„

### ä»æ—§ç‰ˆæœ¬è¿ç§»
```powershell
# 1. å¤‡ä»½æ—§æ–‡ä»¶
cp ui/web_cropper/__init__.py ui/web_cropper/__init__.py.old

# 2. åˆ é™¤æ—§æ„å»º
rm -r ui/web_cropper/frontend/build

# 3. è¿è¡ŒéªŒè¯
python ui/web_cropper/verify_setup.py

# 4. é¦–æ¬¡è¿è¡Œï¼ˆè‡ªåŠ¨æ„å»ºï¼‰
streamlit run app_new.py
```

### å›æ»šï¼ˆå¦‚éœ€ï¼‰
```powershell
# æ¢å¤æ—§ç‰ˆæœ¬
cp ui/web_cropper/__init__.py.old ui/web_cropper/__init__.py

# æ‰‹åŠ¨æ„å»º
cd ui/web_cropper/frontend
npm install && npm run build
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [TEST_AUTO_BUILD.md](./TEST_AUTO_BUILD.md) - å®Œæ•´æµ‹è¯•æŒ‡å—
- [SETUP.md](./SETUP.md) - è®¾ç½®å’Œä½¿ç”¨æ–‡æ¡£
- [verify_setup.py](./verify_setup.py) - éªŒè¯è„šæœ¬

---

## ğŸ‰ æ€»ç»“

### å®ç°ç›®æ ‡ âœ…
- âœ… æ„å»ºä¼˜å…ˆç­–ç•¥
- âœ… è‡ªåŠ¨æ£€æµ‹å’Œæ„å»º
- âœ… å¹‚ç­‰æ€§ï¼ˆå“ˆå¸Œè¿½è¸ªï¼‰
- âœ… å¼€å‘æ¨¡å¼å¯é€‰è¦†ç›–
- âœ… å®¹é”™å’Œæ¸…æ™°é”™è¯¯æç¤º
- âœ… çº¯ Pythonï¼Œæ— å¤–éƒ¨æœåŠ¡ä¾èµ–

### ç”¨æˆ·ä½“éªŒ âœ…
- âœ… é›¶é…ç½®ç”Ÿäº§éƒ¨ç½²
- âœ… é¦–æ¬¡è¿è¡Œè‡ªåŠ¨æ„å»º
- âœ… åç»­è¿è¡Œç§’å¯åŠ¨
- âœ… å¼€å‘æ¨¡å¼çƒ­é‡è½½
- âœ… é”™è¯¯æç¤ºå‹å¥½

### ä»£ç è´¨é‡ âœ…
- âœ… ç±»å‹æç¤ºå®Œæ•´
- âœ… å¼‚å¸¸å¤„ç†å¥å£®
- âœ… æ³¨é‡Šæ¸…æ™°
- âœ… å¯æµ‹è¯•æ€§å¼º

---

## ğŸš€ ä¸‹ä¸€æ­¥

1. **è¿è¡ŒéªŒè¯**
   ```powershell
   python ui/web_cropper/verify_setup.py
   ```

2. **æµ‹è¯•è‡ªåŠ¨æ„å»º**
   ```powershell
   # åˆ é™¤æ„å»ºäº§ç‰©
   rm -r ui/web_cropper/frontend/dist
   
   # è¿è¡Œï¼ˆåº”è‡ªåŠ¨æ„å»ºï¼‰
   streamlit run app_new.py
   ```

3. **æµ‹è¯•ç»„ä»¶åŠŸèƒ½**
   - ä¸Šä¼ å›¾ç‰‡
   - æ‹–åŠ¨è£å‰ªæ¡†
   - ç‚¹å‡» Confirm
   - æŸ¥çœ‹å³ä¾§é¢„è§ˆ

4. **æŸ¥çœ‹å®Œæ•´æµ‹è¯•**
   ```powershell
   cat ui/web_cropper/TEST_AUTO_BUILD.md
   ```

---

**çŠ¶æ€ï¼š** âœ… å®ç°å®Œæˆï¼Œå¾…æµ‹è¯•éªŒè¯

**ç‰ˆæœ¬ï¼š** 2.1.0

**æ—¥æœŸï¼š** 2025-10-25


