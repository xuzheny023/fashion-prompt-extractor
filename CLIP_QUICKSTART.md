# CLIP é¢æ–™è¯†åˆ« - å¿«é€Ÿå¼€å§‹

## ğŸ¯ åŠŸèƒ½æ¦‚è¿°

åŸºäºåŒé€šé“ CLIP æ¨¡å‹çš„æ™ºèƒ½é¢æ–™è¯†åˆ«ç³»ç»Ÿï¼š
- **é€šé“1**: HuggingFace ViT-B/32 (512ç»´) â†’ å…¨å±€è¯­ä¹‰ç‰¹å¾
- **é€šé“2**: LAION ViT-H/14 (1024ç»´) â†’ çº¹ç†ç»†èŠ‚ç‰¹å¾
- **èåˆ**: 1536ç»´å‘é‡ + L2å½’ä¸€åŒ–

## ğŸ“‹ ä½¿ç”¨æ­¥éª¤

### 1. æ„å»ºé¢æ–™å‘é‡åº“

é¦–æ¬¡ä½¿ç”¨éœ€è¦è¿è¡Œä¸€æ¬¡ï¼ˆçº¦15-35åˆ†é’Ÿï¼‰ï¼š

```powershell
# è¿›å…¥é¡¹ç›®ç›®å½•
cd D:\fashion-prompt-extractor

# æ¸…ç†ç¼“å­˜
Remove-Item -Recurse -Force src\__pycache__, tools\__pycache__ -ErrorAction SilentlyContinue

# è¿è¡Œæ„å»ºè„šæœ¬
$env:OPENCLIP_CACHE_DIR = "$PWD\cache\open_clip"
$env:PYTHONUNBUFFERED = "1"
.\venv\Scripts\python.exe -u tools\build_fabric_bank.py
```

**è¾“å‡ºç¤ºä¾‹**ï¼š
```
[INFO] å·²å¤„ç† 64 ä¸ªç±»åˆ«
[OK] saved â†’ D:\fashion-prompt-extractor\data\fabric_bank.npz
[OK] saved â†’ D:\fashion-prompt-extractor\data\fabric_centroids.npz
```

**éªŒè¯ç»´åº¦**ï¼š
```powershell
.\venv\Scripts\python.exe -c "import numpy as np; b=np.load('data/fabric_bank.npz'); print(f'âœ“ å‘é‡ç»´åº¦: {b[b.files[0]].shape[1]}')"
```

åº”è¾“å‡ºï¼š`âœ“ å‘é‡ç»´åº¦: 1536`

### 2. å‘½ä»¤è¡Œæµ‹è¯•æ£€ç´¢

```powershell
# æµ‹è¯•å•å¼ å›¾ç‰‡
.\venv\Scripts\python.exe -u tools\test_retrieval_cli.py data\fabrics\denim\16235f7db5ab74f5bf459d020088786a.jpg

# è¿”å› Top-10 ç»“æœ
.\venv\Scripts\python.exe -u tools\test_retrieval_cli.py path\to\your\image.jpg --top-k 10
```

**è¾“å‡ºç¤ºä¾‹**ï¼š
```
============================================================
æ£€ç´¢ç»“æœ (Top-5)
============================================================
 1. ç‰›ä»”é¢æ–™       (denim          ) 0.856  [â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘] 85%
 2. å¸†å¸ƒ           (canvas         ) 0.723  [â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘] 72%
 3. æ–œçº¹å¸ƒ         (twill          ) 0.689  [â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘] 68%
 4. ç¯èŠ¯ç»’         (corduroy       ) 0.645  [â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘] 64%
 5. äºšéº»           (linen          ) 0.612  [â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘] 61%
============================================================
```

### 3. åœ¨ UI ä¸­ä½¿ç”¨

1. **å¯åŠ¨ Streamlit**ï¼š
   ```powershell
   streamlit run app.py
   ```

2. **æ‰“å¼€æµè§ˆå™¨**ï¼š`http://localhost:8501`

3. **å¯ç”¨ CLIP æ¨¡å¼**ï¼š
   - åœ¨å·¦ä¾§è¾¹æ æ‰¾åˆ° `ğŸ”¬ ä½¿ç”¨ CLIP å‘é‡æ£€ç´¢ (å®éªŒæ€§)`
   - å‹¾é€‰å¯ç”¨

4. **ä¸Šä¼ å›¾ç‰‡å¹¶æŸ¥çœ‹ç»“æœ**ï¼š
   - ä¸Šä¼ æœè£…å›¾ç‰‡
   - ç³»ç»Ÿä¼šæ˜¾ç¤ºï¼š`ğŸ”¬ ä½¿ç”¨ CLIP åŒé€šé“å‘é‡æ£€ç´¢...`
   - æŸ¥çœ‹ Top-5 æ¨èç»“æœï¼Œå¸¦ç½®ä¿¡åº¦æ¡å’Œä¸­æ–‡åç§°

## ğŸ“Š ç»“æœè¯´æ˜

- **ç½®ä¿¡åº¦ â‰¥ 70%** (ç»¿è‰²åŒºåŸŸ): é«˜å¯ä¿¡åº¦
- **ç½®ä¿¡åº¦ 30-70%** (é»„è‰²åŒºåŸŸ): ä¸­ç­‰å¯ä¿¡åº¦
- **ç½®ä¿¡åº¦ < 30%** (çº¢è‰²åŒºåŸŸ): ä½å¯ä¿¡åº¦ï¼Œæ˜¾ç¤º `âš ï¸ å»ºè®®äººå·¥ç¡®è®¤/è¡¥å›¾`

## ğŸ”§ é«˜çº§åŠŸèƒ½

### æ£€ç´¢ç­–ç•¥

ç³»ç»Ÿé‡‡ç”¨ä¸¤é˜¶æ®µæ£€ç´¢ï¼š

1. **ç²—æ’**ï¼ˆå¿«ï¼‰ï¼šä½¿ç”¨ç±»ä¸­å¿ƒå‘é‡ï¼ˆcentroidsï¼‰
2. **ç²¾æ’**ï¼ˆå‡†ï¼‰ï¼šå½“ Top1 å’Œ Top2 åˆ†æ•°å·® < 0.03 æ—¶ï¼Œå¯¹å…¨éƒ¨æ ·æœ¬é‡æ–°è®¡ç®—

### è‡ªå®šä¹‰é˜ˆå€¼

```python
# åœ¨ä»£ç ä¸­è°ƒæ•´
recommend_fabrics_clip(image, top_k=5, threshold=0.03)
```

- `threshold` è¶Šå° â†’ è¶Šå®¹æ˜“è§¦å‘ç²¾æ’ â†’ æ›´å‡†ä½†æ›´æ…¢
- `threshold` è¶Šå¤§ â†’ æ›´å¤šä½¿ç”¨ç²—æ’ â†’ æ›´å¿«ä½†å¯èƒ½ä¸å‡†

## ğŸ“ æ–‡ä»¶è¯´æ˜

| æ–‡ä»¶ | è¯´æ˜ |
|------|------|
| `data/fabric_bank.npz` | å®Œæ•´å‘é‡åº“ (æ‰€æœ‰æ ·æœ¬çš„1536ç»´å‘é‡) |
| `data/fabric_centroids.npz` | ç±»ä¸­å¿ƒå‘é‡åº“ (æ¯ä¸ªç±»çš„å¹³å‡å‘é‡) |
| `data/fabric_labels.json` | ä¸­æ–‡æ ‡ç­¾æ˜ å°„ |
| `data/fabric_aliases.json` | ä¸­æ–‡åˆ«åï¼ˆç”¨äºæœç´¢ï¼‰ |
| `src/dual_clip.py` | åŒé€šé“ CLIP ç¼–ç å™¨ |
| `src/fabric_clip_ranker.py` | CLIP é¢æ–™æ¨èå™¨ |
| `src/fabric_labels.py` | æ ‡ç­¾ç®¡ç† API |
| `tools/build_fabric_bank.py` | å‘é‡åº“æ„å»ºè„šæœ¬ |
| `tools/test_retrieval_cli.py` | å‘½ä»¤è¡Œæ£€ç´¢æµ‹è¯•å·¥å…· |

## ğŸ› å¸¸è§é—®é¢˜

### Q: å‘é‡ç»´åº¦è¿˜æ˜¯ 512 è€Œä¸æ˜¯ 1536ï¼Ÿ

**A**: Python ä½¿ç”¨äº†æ—§ç¼“å­˜ã€‚æ‰§è¡Œï¼š
```powershell
Remove-Item -Recurse -Force src\__pycache__, tools\__pycache__
.\venv\Scripts\python.exe -u tools\build_fabric_bank.py
```

### Q: é¦–æ¬¡è¿è¡Œå¾ˆæ…¢ï¼Ÿ

**A**: æ­£å¸¸ã€‚é¦–æ¬¡éœ€è¦ä¸‹è½½ LAION ViT-H/14 æ¨¡å‹ï¼ˆçº¦1.6GBï¼‰ã€‚åç»­è¿è¡Œä¼šå¿«å¾ˆå¤šã€‚

### Q: UI æŠ¥é”™ "å‘é‡åº“æœªæ‰¾åˆ°"ï¼Ÿ

**A**: è¯·å…ˆè¿è¡Œæ­¥éª¤1æ„å»ºå‘é‡åº“ã€‚

### Q: è¯†åˆ«å‡†ç¡®ç‡ä¸é«˜ï¼Ÿ

**A**: å¯èƒ½åŸå› ï¼š
- é¢æ–™ç±»åˆ«å›¾ç‰‡æ•°é‡ä¸è¶³ï¼ˆ<5å¼ ï¼‰
- å›¾ç‰‡è´¨é‡å·®æˆ–è§’åº¦é—®é¢˜
- é¢æ–™ç±»åˆ«æœ¬èº«ç›¸ä¼¼ï¼ˆå¦‚ä¸åŒç±»å‹çš„ç»‡ç‰©ï¼‰

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. è¡¥å……é«˜è´¨é‡é¢æ–™å›¾ç‰‡
2. é‡æ–°æ„å»ºå‘é‡åº“
3. è°ƒæ•´ `threshold` å‚æ•°è§¦å‘ç²¾æ’

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–

- **é¦–æ¬¡åŠ è½½æ…¢**ï¼šCLIP æ¨¡å‹åŠ è½½éœ€è¦å‡ ç§’ï¼Œåç»­ä½¿ç”¨å•ä¾‹æ¨¡å¼ç¼“å­˜
- **å¤§å›¾å¤„ç†æ…¢**ï¼šå»ºè®®å°†å›¾ç‰‡ç¼©æ”¾åˆ° 1024px ä»¥å†…
- **å¤šç±»åˆ«æ…¢**ï¼šç±»ä¸­å¿ƒç²—æ’å¯ä»¥å¤„ç† 100+ ç±»åˆ«ï¼Œå…¨æ ·æœ¬ç²¾æ’å»ºè®® <50 ç±»åˆ«

## ğŸ¨ æ‰©å±•é¢æ–™åº“

å¦‚éœ€æ·»åŠ æ–°é¢æ–™ç±»åˆ«ï¼š

1. åœ¨ `data/fabrics/` ä¸‹åˆ›å»ºæ–°æ–‡ä»¶å¤¹ï¼ˆå°å†™è‹±æ–‡ï¼‰
2. æ·»åŠ è‡³å°‘ 5 å¼ é«˜è´¨é‡çº¹ç†å›¾ç‰‡ï¼ˆ512px+ï¼Œæ— å°èŠ±ï¼‰
3. åœ¨ `data/fabric_labels.json` æ·»åŠ ä¸­æ–‡å
4. åœ¨ `data/fabric_aliases.json` æ·»åŠ åˆ«åï¼ˆå¯é€‰ï¼‰
5. é‡æ–°è¿è¡Œ `build_fabric_bank.py`

---

**ç‰ˆæœ¬**: 1.0  
**æ›´æ–°æ—¶é—´**: 2025-10-12


