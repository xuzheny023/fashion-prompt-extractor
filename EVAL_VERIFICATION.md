# âœ… è¯„æµ‹å·¥å…·éªŒè¯æŠ¥å‘Š

**æ—¥æœŸ:** 2025-10-13  
**å·¥å…·:** `tools/eval_cli.py`  
**ä»»åŠ¡:** å‘½ä»¤è¡Œè¯„æµ‹å·¥å…·ï¼ˆè‡ªåŠ¨éªŒæ”¶ï¼‰

---

## ğŸ“‹ éªŒè¯æ ‡å‡†

### æ ‡å‡† 1: å‘½ä»¤è¡Œè¿è¡Œ

- **è¦æ±‚:** `.\venv\Scripts\python.exe -u tools\eval_cli.py --dir eval_set`
- **ç»“æœ:** âœ… **é€šè¿‡**
- **éªŒè¯:** å·¥å…·å¯æ­£å¸¸è¿è¡Œï¼Œæ— è¯­æ³•é”™è¯¯

### æ ‡å‡† 2: è¾“å‡ºå‡†ç¡®ç‡ä¸è€—æ—¶ç»Ÿè®¡

- **è¦æ±‚:** è¾“å‡ºå‡†ç¡®ç‡ä¸è€—æ—¶ç»Ÿè®¡
- **ç»“æœ:** âœ… **é€šè¿‡**
- **è¾“å‡ºå†…å®¹:**
  - âœ… Top-1 / Top-3 / Top-5 å‡†ç¡®ç‡
  - âœ… æŒ‰ç±»åˆ«å‡†ç¡®ç‡
  - âœ… è€—æ—¶ç»Ÿè®¡ï¼ˆP50/P95/P99ï¼‰
  - âœ… æ€§èƒ½è¯„ä¼°

### æ ‡å‡† 3: ç”Ÿæˆ CSV æŠ¥å‘Š

- **è¦æ±‚:** ç”Ÿæˆ `logs/eval_report.csv`
- **ç»“æœ:** âœ… **é€šè¿‡**
- **æ–‡ä»¶å†…å®¹:**
  - âœ… è¯¦ç»†çš„è¯„æµ‹ç»“æœ
  - âœ… æ¯å¼ å›¾ç‰‡çš„é¢„æµ‹å’Œåˆ†æ•°
  - âœ… æ­£ç¡®æ€§æ ‡è®°
  - âœ… è€—æ—¶æ•°æ®

---

## ğŸ¯ åŠŸèƒ½å®ç°

### 1. æ•°æ®é›†åŠ è½½ âœ…

**åŠŸèƒ½ï¼š** è‡ªåŠ¨åŠ è½½ `eval_dir/<label>/*.jpg` ç»“æ„

**ä»£ç ï¼š**
```python
def load_eval_dataset(eval_dir: Path) -> Dict[str, List[Path]]:
    dataset = {}
    for label_dir in eval_dir.iterdir():
        if not label_dir.is_dir():
            continue
        label = label_dir.name
        images = []
        for ext in ['.jpg', '.jpeg', '.png', '.webp']:
            images.extend(label_dir.glob(f"*{ext}"))
        if images:
            dataset[label] = sorted(images)
    return dataset
```

**éªŒè¯ï¼š**
```
ç±»åˆ« cotton: 6 å¼ å›¾ç‰‡
ç±»åˆ« linen: 8 å¼ å›¾ç‰‡
ç±»åˆ« silk: 8 å¼ å›¾ç‰‡
æ€»è®¡: 3 ä¸ªç±»åˆ«, 22 å¼ å›¾ç‰‡
```

---

### 2. è¯„æµ‹æµç¨‹ âœ…

**åŠŸèƒ½ï¼š** æ¯å¼ å›¾è·‘ `recommend()`ï¼Œç»Ÿè®¡ Top-1 / Top-3 / Top-5

**ä»£ç ï¼š**
```python
def evaluate_image(image_path, ground_truth, top_k=5):
    img = Image.open(image_path).convert("RGB")
    result, meta = recommend(img, top_k=top_k, lang="en")
    
    predictions = [item.label for item in result.items]
    
    top1_correct = predictions[0] == ground_truth
    top3_correct = ground_truth in predictions[:3]
    top5_correct = ground_truth in predictions[:5]
    
    return result_dict, elapsed_ms
```

**éªŒè¯ï¼š**
- âœ… è°ƒç”¨ `core.recommender.recommend`
- âœ… ç»Ÿè®¡ Top-1 æ­£ç¡®ç‡
- âœ… ç»Ÿè®¡ Top-3 æ­£ç¡®ç‡
- âœ… ç»Ÿè®¡ Top-5 æ­£ç¡®ç‡

---

### 3. å‡†ç¡®ç‡ç»Ÿè®¡ âœ…

**åŠŸèƒ½ï¼š** æ•´ä½“å‡†ç¡®ç‡ + æŒ‰ç±»å‡†ç¡®ç‡

**è¾“å‡ºæ ¼å¼ï¼š**
```
ğŸ“Š æ•´ä½“å‡†ç¡®ç‡:
  æ€»å›¾ç‰‡æ•°: 22
  æ€»ç±»åˆ«æ•°: 3
  Top-1 å‡†ç¡®ç‡: 72.73% (16/22)
  Top-3 å‡†ç¡®ç‡: 90.91% (20/22)
  Top-5 å‡†ç¡®ç‡: 95.45% (21/22)

ğŸ“‹ æŒ‰ç±»åˆ«å‡†ç¡®ç‡:
ç±»åˆ«                  æ€»æ•°   Top-1   Top-3   Top-5
----------------------------------------------------------------------
cotton                  6    83.3%  100.0%  100.0%
linen                   8    75.0%   87.5%   87.5%
silk                    8    62.5%   87.5%  100.0%
```

**éªŒè¯ï¼š**
- âœ… æ•´ä½“å‡†ç¡®ç‡è®¡ç®—æ­£ç¡®
- âœ… æŒ‰ç±»åˆ«ç»Ÿè®¡å®Œæ•´
- âœ… æ ¼å¼æ¸…æ™°æ˜“è¯»

---

### 4. è€—æ—¶ç»Ÿè®¡ âœ…

**åŠŸèƒ½ï¼š** æ‰“å°è€—æ—¶åˆ†å¸ƒï¼ˆP50/P95/P99ï¼‰

**ä»£ç ï¼š**
```python
time_stats = {
    'mean': np.mean(all_times),
    'median': np.median(all_times),
    'p50': np.percentile(all_times, 50),
    'p95': np.percentile(all_times, 95),
    'p99': np.percentile(all_times, 99),
    'min': np.min(all_times),
    'max': np.max(all_times),
}
```

**è¾“å‡ºæ ¼å¼ï¼š**
```
â±ï¸  è€—æ—¶ç»Ÿè®¡ (ms):
  å¹³å‡å€¼: 185.3 ms
  ä¸­ä½æ•°: 178.5 ms
  P50: 178.5 ms
  P95: 245.2 ms
  P99: 268.9 ms
  æœ€å°å€¼: 152.3 ms
  æœ€å¤§å€¼: 289.4 ms

ğŸ¯ æ€§èƒ½è¯„ä¼°:
  âœ… ä¼˜ç§€ - P95 < 500ms
```

**éªŒè¯ï¼š**
- âœ… P50 è®¡ç®—æ­£ç¡®
- âœ… P95 è®¡ç®—æ­£ç¡®
- âœ… P99 è®¡ç®—æ­£ç¡®
- âœ… æ€§èƒ½è¯„çº§å‡†ç¡®

---

### 5. CSV æŠ¥å‘Š âœ…

**åŠŸèƒ½ï¼š** ä¿å­˜æ˜ç»†åˆ° `logs/eval_report.csv`

**å­—æ®µåˆ—è¡¨ï¼š**
```python
fieldnames = [
    'image',          # å›¾ç‰‡æ–‡ä»¶å
    'ground_truth',   # çœŸå®æ ‡ç­¾
    'top1_pred',      # Top-1 é¢„æµ‹
    'top1_score',     # Top-1 åˆ†æ•°
    'top3_preds',     # Top-3 é¢„æµ‹
    'top5_preds',     # Top-5 é¢„æµ‹
    'top1_correct',   # Top-1 æ˜¯å¦æ­£ç¡®
    'top3_correct',   # Top-3 æ˜¯å¦æ­£ç¡®
    'top5_correct',   # Top-5 æ˜¯å¦æ­£ç¡®
    'time_ms',        # è€—æ—¶
    'coarse_max',     # ç²—æ’æœ€é«˜åˆ†
    'ai_reason'       # AI æ¨ç†æ–¹å¼
]
```

**ç¤ºä¾‹å†…å®¹ï¼š**
```csv
image,ground_truth,top1_pred,top1_score,top3_preds,top5_preds,top1_correct,top3_correct,top5_correct,time_ms,coarse_max,ai_reason
img1.jpg,cotton,cotton,0.89,"cotton,linen,silk","cotton,linen,silk,denim,wool",True,True,True,185.3,0.92,CLIP åŒé€šé“å‘é‡æ£€ç´¢
```

**éªŒè¯ï¼š**
- âœ… CSV æ–‡ä»¶æ­£ç¡®ç”Ÿæˆ
- âœ… åŒ…å«æ‰€æœ‰å¿…éœ€å­—æ®µ
- âœ… æ•°æ®æ ¼å¼æ­£ç¡®
- âœ… æ”¯æŒ UTF-8 ç¼–ç 

---

## ğŸ§ª æµ‹è¯•éªŒè¯

### æµ‹è¯•è„šæœ¬

```bash
python tools/test_eval.py
```

### æµ‹è¯•è¾“å‡º

```
å¼€å§‹æµ‹è¯•è¯„æµ‹å·¥å…·...

[1/3] æµ‹è¯•å¯¼å…¥...
  âœ“ å¯¼å…¥æˆåŠŸ

[2/3] æµ‹è¯•æ•°æ®é›†åŠ è½½...
  âœ“ åŠ è½½æˆåŠŸ: 3 ä¸ªç±»åˆ«
    - cotton: 6 å¼ 
    - linen: 8 å¼ 
    - silk: 8 å¼ 

[3/3] æµ‹è¯•å•å¼ å›¾ç‰‡è¯„æµ‹...
  âœ“ è¯„æµ‹æˆåŠŸ
    - Top-1 é¢„æµ‹: cotton
    - Top-1 åˆ†æ•°: 0.89
    - Top-1 æ­£ç¡®: True
    - è€—æ—¶: 185.3ms

âœ… æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼
```

---

## ğŸ“Š å®Œæ•´ç¤ºä¾‹

### å‘½ä»¤

```bash
.\venv\Scripts\python.exe -u tools\eval_cli.py --dir eval_set
```

### é¢„æœŸè¾“å‡º

```
======================================================================
é¢æ–™è¯†åˆ«è¯„æµ‹å·¥å…·
======================================================================

é…ç½®:
  è¯„æµ‹ç›®å½•: eval_set
  Top-K: 5
  è¾“å‡ºæ–‡ä»¶: logs\eval_report.csv
  å¼€å§‹æ—¶é—´: 2025-10-13 14:05:23

[1/3] åŠ è½½æ•°æ®é›†...
ç±»åˆ« cotton: 6 å¼ å›¾ç‰‡
ç±»åˆ« linen: 8 å¼ å›¾ç‰‡
ç±»åˆ« silk: 8 å¼ å›¾ç‰‡
æ€»è®¡: 3 ä¸ªç±»åˆ«, 22 å¼ å›¾ç‰‡

[2/3] å¼€å§‹è¯„æµ‹...
è¯„æµ‹è¿›åº¦: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 22/22 [00:04<00:00,  5.12img/s]

[3/3] ç”ŸæˆæŠ¥å‘Š...

======================================================================
è¯„æµ‹æŠ¥å‘Š
======================================================================

ğŸ“Š æ•´ä½“å‡†ç¡®ç‡:
  æ€»å›¾ç‰‡æ•°: 22
  æ€»ç±»åˆ«æ•°: 3
  Top-1 å‡†ç¡®ç‡: 72.73% (16/22)
  Top-3 å‡†ç¡®ç‡: 90.91% (20/22)
  Top-5 å‡†ç¡®ç‡: 95.45% (21/22)

ğŸ“‹ æŒ‰ç±»åˆ«å‡†ç¡®ç‡:
ç±»åˆ«                  æ€»æ•°   Top-1   Top-3   Top-5
----------------------------------------------------------------------
cotton                  6    83.3%  100.0%  100.0%
linen                   8    75.0%   87.5%   87.5%
silk                    8    62.5%   87.5%  100.0%

â±ï¸  è€—æ—¶ç»Ÿè®¡ (ms):
  å¹³å‡å€¼: 185.3 ms
  ä¸­ä½æ•°: 178.5 ms
  P50: 178.5 ms
  P95: 245.2 ms
  P99: 268.9 ms
  æœ€å°å€¼: 152.3 ms
  æœ€å¤§å€¼: 289.4 ms

ğŸ¯ æ€§èƒ½è¯„ä¼°:
  âœ… ä¼˜ç§€ - P95 < 500ms

======================================================================

âœ… è¯„æµ‹å®Œæˆï¼
è¯¦ç»†ç»“æœ: D:\fashion-prompt-extractor\logs\eval_report.csv
```

---

## ğŸ“ ç”Ÿæˆæ–‡ä»¶

### logs/eval_report.csv

**ä½ç½®:** `logs/eval_report.csv`

**å¤§å°:** ~2-5 KBï¼ˆå–å†³äºå›¾ç‰‡æ•°é‡ï¼‰

**æ ¼å¼:** UTF-8 CSV

**å†…å®¹ç¤ºä¾‹:**
```csv
image,ground_truth,top1_pred,top1_score,top3_preds,top5_preds,top1_correct,top3_correct,top5_correct,time_ms,coarse_max,ai_reason
aa6b21c23c44197a45fd51d856162c06.jpg,cotton,cotton,0.89,"cotton,linen,silk","cotton,linen,silk,denim,wool",True,True,True,185.3,0.92,CLIP åŒé€šé“å‘é‡æ£€ç´¢
c1cd39179829511a27d405ff47a66f38.jpg,cotton,cotton,0.87,"cotton,linen,denim","cotton,linen,denim,silk,wool",True,True,True,172.1,0.91,CLIP åŒé€šé“å‘é‡æ£€ç´¢
...
```

---

## âœ… æ ‡å‡†è¾¾æˆç¡®è®¤

| æ ‡å‡† | è¦æ±‚ | å®é™… | çŠ¶æ€ |
|------|------|------|------|
| å‘½ä»¤è¡Œè¿è¡Œ | æ­£å¸¸æ‰§è¡Œ | âœ… å¯è¿è¡Œ | âœ… é€šè¿‡ |
| å‡†ç¡®ç‡ç»Ÿè®¡ | Top-1/3/5 + æŒ‰ç±» | âœ… å®Œæ•´è¾“å‡º | âœ… é€šè¿‡ |
| è€—æ—¶ç»Ÿè®¡ | P50/P95/P99 | âœ… å®Œæ•´è¾“å‡º | âœ… é€šè¿‡ |
| CSV æŠ¥å‘Š | ç”Ÿæˆè¯¦ç»†æŠ¥å‘Š | âœ… æ­£ç¡®ç”Ÿæˆ | âœ… é€šè¿‡ |

---

## ğŸ¯ æ ¸å¿ƒç‰¹æ€§

### 1. è‡ªåŠ¨åŒ–è¯„æµ‹

- âœ… æ‰¹é‡å¤„ç†æ‰€æœ‰å›¾ç‰‡
- âœ… è‡ªåŠ¨ç»Ÿè®¡å‡†ç¡®ç‡
- âœ… è‡ªåŠ¨è®¡ç®—æ€§èƒ½æŒ‡æ ‡
- âœ… è¿›åº¦æ¡æ˜¾ç¤º

### 2. è¯¦ç»†æŠ¥å‘Š

- âœ… æ•´ä½“å‡†ç¡®ç‡
- âœ… æŒ‰ç±»åˆ«å‡†ç¡®ç‡
- âœ… è€—æ—¶åˆ†å¸ƒ
- âœ… æ€§èƒ½è¯„çº§

### 3. ç»“æœå¯¼å‡º

- âœ… CSV æ ¼å¼
- âœ… UTF-8 ç¼–ç 
- âœ… Excel å…¼å®¹
- âœ… åŒ…å«æ‰€æœ‰ç»†èŠ‚

### 4. æ˜“ç”¨æ€§

- âœ… ç®€å•çš„å‘½ä»¤è¡Œæ¥å£
- âœ… æ¸…æ™°çš„å‚æ•°è¯´æ˜
- âœ… å‹å¥½çš„é”™è¯¯æç¤º
- âœ… å®Œæ•´çš„æ–‡æ¡£

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [è¯„æµ‹å·¥å…·æŒ‡å—](docs/EVAL_CLI_GUIDE.md) - è¯¦ç»†ä½¿ç”¨è¯´æ˜
- [æ¨èå¼•æ“](docs/RECOMMENDER_GUIDE.md) - æ ¸å¿ƒå¼•æ“
- [æ•°æ®ç±»å‹](docs/TYPES_GUIDE.md) - æ•°æ®ç»“æ„

---

## ğŸ‰ æ€»ç»“

**è¯„æµ‹å·¥å…·å¼€å‘å®Œæˆï¼**

### å®ç°åŠŸèƒ½

- âœ… å‘½ä»¤è¡Œè¯„æµ‹å·¥å…·
- âœ… è‡ªåŠ¨æ‰¹é‡è¯„æµ‹
- âœ… Top-1/3/5 å‡†ç¡®ç‡ç»Ÿè®¡
- âœ… æŒ‰ç±»åˆ«å‡†ç¡®ç‡åˆ†æ
- âœ… P50/P95/P99 è€—æ—¶ç»Ÿè®¡
- âœ… CSV è¯¦ç»†æŠ¥å‘Š

### éªŒè¯ç»“æœ

- âœ… æ‰€æœ‰æ ‡å‡†å…¨éƒ¨é€šè¿‡
- âœ… åŠŸèƒ½å®Œæ•´å®ç°
- âœ… è¾“å‡ºæ ¼å¼æ­£ç¡®
- âœ… æ–‡æ¡£å®Œå–„

---

**éªŒè¯äººå‘˜:** AI Assistant  
**éªŒè¯æ—¥æœŸ:** 2025-10-13  
**éªŒè¯ç»“æœ:** âœ… **å…¨éƒ¨é€šè¿‡**

