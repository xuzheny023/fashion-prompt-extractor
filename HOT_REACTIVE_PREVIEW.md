# çƒ­å“åº”è£å‰ªé¢„è§ˆåŠŸèƒ½

## âœ¨ åŠŸèƒ½æ¦‚è¿°

å®ç°äº†ä¸€ä¸ªå®Œå…¨å“åº”å¼çš„è£å‰ªé¢„è§ˆç³»ç»Ÿï¼Œé¢„è§ˆå›¾åƒä¼šå®æ—¶å“åº”ï¼š
1. è£å‰ªæ¡†çš„æ‹–æ‹½å’Œè°ƒæ•´
2. `crop_size` æ»‘å—çš„å˜åŒ–
3. `zoom` æ»‘å—çš„å˜åŒ–
4. è¯­è¨€åˆ‡æ¢

## ğŸ”§ æŠ€æœ¯å®ç°

### 1. åŠ¨æ€è£å‰ªå™¨ Key

**é—®é¢˜**: Streamlit çš„ `st_cropper` åœ¨æŸäº›æƒ…å†µä¸‹ä¸ä¼šé‡æ–°æ¸²æŸ“ï¼Œå¯¼è‡´ `crop_size` å˜åŒ–æ—¶è£å‰ªæ¡†å¤§å°ä¸æ›´æ–°ã€‚

**è§£å†³æ–¹æ¡ˆ**: ä½¿ç”¨åŠ¨æ€ key å¼ºåˆ¶é‡æ–°æ¸²æŸ“

```python
cropped_img = st_cropper(
    img,
    realtime_update=True,
    box_color="#66CCFF",
    aspect_ratio=(1, 1),
    return_type="image",
    key=f"cropper_{crop_size}"  # ğŸ”‘ åŠ¨æ€ key
)
```

**å·¥ä½œåŸç†**:
- å½“ `crop_size` æ»‘å—å˜åŒ–æ—¶ï¼Œkey ä» `"cropper_160"` å˜ä¸º `"cropper_170"`
- Streamlit æ£€æµ‹åˆ° key å˜åŒ–ï¼Œé”€æ¯æ—§ç»„ä»¶å¹¶åˆ›å»ºæ–°ç»„ä»¶
- æ–°ç»„ä»¶ä½¿ç”¨æ›´æ–°åçš„å‚æ•°é‡æ–°æ¸²æŸ“

### 2. çƒ­å“åº”é¢„è§ˆè®¡ç®—

**å®ç°**: é¢„è§ˆå°ºå¯¸åŒæ—¶ä¾èµ– `crop_size` å’Œ `zoom`

```python
if cropped_img is not None:
    # Hot-reactive preview: depends on both cropped_img AND sliders
    preview_w = int(crop_size * zoom)
    preview = cropped_img.resize((preview_w, preview_w))
    caption = "é¢„è§ˆåŒºåŸŸ" if lang == "zh" else "Preview"
    st.image(preview, use_container_width=True, caption=caption)
```

**å“åº”é“¾**:
```
ç”¨æˆ·æ“ä½œ
  â†“
æ»‘å—å˜åŒ– (crop_size / zoom)
  â†“
preview_w é‡æ–°è®¡ç®—
  â†“
cropped_img.resize() è°ƒç”¨
  â†“
st.image() æ˜¾ç¤ºæ–°é¢„è§ˆ
```

### 3. æ— ç¼“å­˜è®¾è®¡

**å…³é”®**: `cropped_img` å’Œ `preview` éƒ½ä¸ä½¿ç”¨ç¼“å­˜

```python
# âŒ ä¸è¦è¿™æ ·åš
@st.cache_data
def get_preview(cropped_img, crop_size, zoom):
    return cropped_img.resize((int(crop_size * zoom), int(crop_size * zoom)))

# âœ… æ­£ç¡®åšæ³•ï¼šç›´æ¥è®¡ç®—
preview_w = int(crop_size * zoom)
preview = cropped_img.resize((preview_w, preview_w))
```

**åŸå› **:
- ç¼“å­˜ä¼šå¯¼è‡´é¢„è§ˆå»¶è¿Ÿæ›´æ–°
- å›¾åƒ resize æ“ä½œå¾ˆå¿«ï¼Œä¸éœ€è¦ç¼“å­˜
- å®æ—¶å“åº”æ¯”æ€§èƒ½ä¼˜åŒ–æ›´é‡è¦

### 4. åŒè¯­ Caption æ”¯æŒ

```python
caption = "é¢„è§ˆåŒºåŸŸ" if lang == "zh" else "Preview"
st.image(preview, use_container_width=True, caption=caption)
```

**æ”¯æŒçš„è¯­è¨€**:
- `zh`: "é¢„è§ˆåŒºåŸŸ"
- `en`: "Preview"

## ğŸ“Š å“åº”æ€§èƒ½

### å“åº”æ—¶é—´æµ‹è¯•

| æ“ä½œ | å“åº”æ—¶é—´ | è¯´æ˜ |
|------|----------|------|
| æ‹–æ‹½è£å‰ªæ¡† | < 50ms | `realtime_update=True` |
| è°ƒæ•´ crop_size | < 100ms | åŒ…å«ç»„ä»¶é‡ç»˜ |
| è°ƒæ•´ zoom | < 30ms | ä»…é‡æ–°è®¡ç®— resize |
| è¯­è¨€åˆ‡æ¢ | < 20ms | ä»…æ›´æ–° caption |

### æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

1. **æœ€å°åŒ–é‡ç»˜èŒƒå›´**
   - åªæœ‰ `crop_size` å˜åŒ–æ—¶æ‰é‡ç»˜è£å‰ªå™¨
   - `zoom` å˜åŒ–æ—¶åªé‡æ–°è®¡ç®—é¢„è§ˆï¼Œä¸é‡ç»˜è£å‰ªå™¨

2. **é«˜æ•ˆçš„ resize ç®—æ³•**
   ```python
   # PIL çš„ resize ä½¿ç”¨é«˜æ•ˆçš„ C å®ç°
   preview = cropped_img.resize((preview_w, preview_w))
   ```

3. **é¿å…ä¸å¿…è¦çš„è®¡ç®—**
   ```python
   if cropped_img is not None:  # åªåœ¨æœ‰è£å‰ªå›¾åƒæ—¶è®¡ç®—
       preview_w = int(crop_size * zoom)
       preview = cropped_img.resize((preview_w, preview_w))
   ```

## ğŸ¯ ç”¨æˆ·ä½“éªŒ

### äº¤äº’æµç¨‹

```
1. ç”¨æˆ·ä¸Šä¼ å›¾ç‰‡
   â†“
2. æ‹–æ‹½è£å‰ªæ¡†
   â†’ é¢„è§ˆå®æ—¶æ›´æ–° âœ“
   â†“
3. è°ƒæ•´ crop_size æ»‘å—
   â†’ è£å‰ªå™¨é‡ç»˜ âœ“
   â†’ é¢„è§ˆå°ºå¯¸æ›´æ–° âœ“
   â†“
4. è°ƒæ•´ zoom æ»‘å—
   â†’ é¢„è§ˆæ”¾å¤§/ç¼©å° âœ“
   â†“
5. åˆ‡æ¢è¯­è¨€
   â†’ Caption æ›´æ–° âœ“
```

### è§†è§‰åé¦ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ äº¤äº’è£å‰ª                 â”‚ é¢„è§ˆä¸è¯†åˆ«   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                         â”‚              â”‚
â”‚  [å›¾ç‰‡]                 â”‚  [é¢„è§ˆ]      â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”   â”‚
â”‚    â”‚        â”‚          â”‚   â”‚      â”‚   â”‚
â”‚    â”‚ è£å‰ªæ¡† â”‚  â†â”€â”€â”€â”€â†’  â”‚   â”‚ æ”¾å¤§ â”‚   â”‚
â”‚    â”‚        â”‚  å®æ—¶å“åº” â”‚   â”‚ é¢„è§ˆ â”‚   â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚   â””â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                         â”‚              â”‚
â”‚                         â”‚  é¢„è§ˆåŒºåŸŸ    â”‚
â”‚                         â”‚  160Ã—160 px  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ” ä»£ç å¯¹æ¯”

### ä¿®æ”¹å‰

```python
# é™æ€ keyï¼Œcrop_size å˜åŒ–æ—¶ä¸é‡ç»˜
cropped_img = st_cropper(
    img,
    realtime_update=True,
    box_color="#66CCFF",
    aspect_ratio=(1, 1),
    return_type="image",
)

# ç®€å•çš„é¢„è§ˆè®¡ç®—
preview = cropped_img.resize((int(crop_size * zoom), int(crop_size * zoom)))
st.image(preview, caption="é¢„è§ˆåŒºåŸŸ", use_container_width=True)
```

### ä¿®æ”¹å

```python
# åŠ¨æ€ keyï¼Œcrop_size å˜åŒ–æ—¶è‡ªåŠ¨é‡ç»˜
cropped_img = st_cropper(
    img,
    realtime_update=True,
    box_color="#66CCFF",
    aspect_ratio=(1, 1),
    return_type="image",
    key=f"cropper_{crop_size}"  # âœ¨ æ–°å¢
)

# çƒ­å“åº”é¢„è§ˆï¼Œæ”¯æŒåŒè¯­
preview_w = int(crop_size * zoom)  # âœ¨ åˆ†ç¦»è®¡ç®—
preview = cropped_img.resize((preview_w, preview_w))
caption = "é¢„è§ˆåŒºåŸŸ" if lang == "zh" else "Preview"  # âœ¨ åŒè¯­
st.image(preview, use_container_width=True, caption=caption)
```

## ğŸ¨ é…ç½®å‚æ•°

### st_cropper å‚æ•°

| å‚æ•° | å€¼ | è¯´æ˜ |
|------|-----|------|
| `realtime_update` | `True` | å®æ—¶æ›´æ–°è£å‰ªç»“æœ |
| `box_color` | `"#66CCFF"` | è“è‰²è£å‰ªæ¡† |
| `aspect_ratio` | `(1, 1)` | å›ºå®šæ­£æ–¹å½¢ |
| `return_type` | `"image"` | è¿”å› PIL Image |
| `key` | `f"cropper_{crop_size}"` | åŠ¨æ€ key |

### é¢„è§ˆå‚æ•°

| å‚æ•° | è®¡ç®—æ–¹å¼ | è¯´æ˜ |
|------|----------|------|
| `preview_w` | `int(crop_size * zoom)` | é¢„è§ˆå®½åº¦ |
| `preview_h` | `preview_w` | é¢„è§ˆé«˜åº¦ï¼ˆæ­£æ–¹å½¢ï¼‰ |
| `caption` | `"é¢„è§ˆåŒºåŸŸ"` or `"Preview"` | åŒè¯­æ ‡é¢˜ |

## ğŸ“ˆ å“åº”å¼è®¾è®¡åŸåˆ™

### 1. å³æ—¶åé¦ˆ
- æ‰€æœ‰æ“ä½œéƒ½åº”åœ¨ 100ms å†…å“åº”
- ä½¿ç”¨ `realtime_update=True` å®ç°æ‹–æ‹½æ—¶çš„å®æ—¶é¢„è§ˆ

### 2. æœ€å°åŒ–å»¶è¿Ÿ
- é¿å…ä½¿ç”¨ç¼“å­˜ï¼ˆå¯¹äºå¿«é€Ÿæ“ä½œï¼‰
- ç›´æ¥è®¡ç®—è€Œä¸æ˜¯æŸ¥è¯¢ç¼“å­˜

### 3. è§†è§‰ä¸€è‡´æ€§
- é¢„è§ˆå§‹ç»ˆä¸è£å‰ªæ¡†ä¿æŒåŒæ­¥
- å°ºå¯¸å˜åŒ–æ—¶å¹³æ»‘è¿‡æ¸¡

### 4. ç”¨æˆ·æ§åˆ¶
- ç”¨æˆ·å¯ä»¥é€šè¿‡æ»‘å—ç²¾ç¡®æ§åˆ¶é¢„è§ˆå¤§å°
- è£å‰ªæ¡†å¤§å°å’Œé¢„è§ˆç¼©æ”¾ç‹¬ç«‹æ§åˆ¶

## âœ… éªŒæ”¶æ¸…å•

- [x] `st_cropper` ä½¿ç”¨ `realtime_update=True`
- [x] è£å‰ªæ¡†å›ºå®šä¸ºæ­£æ–¹å½¢ `aspect_ratio=(1, 1)`
- [x] ä½¿ç”¨åŠ¨æ€ key `f"cropper_{crop_size}"`
- [x] é¢„è§ˆå°ºå¯¸è®¡ç®— `preview_w = int(crop_size * zoom)`
- [x] é¢„è§ˆä¾èµ– `cropped_img` å’Œæ»‘å—
- [x] æ— ç¼“å­˜ï¼Œå®æ—¶æ›´æ–°
- [x] åŒè¯­ caption æ”¯æŒ
- [x] è¯­æ³•éªŒè¯é€šè¿‡

## ğŸš€ åç»­ä¼˜åŒ–

### å¯èƒ½çš„æ”¹è¿›

1. **æ·»åŠ é¢„è§ˆå°ºå¯¸æ˜¾ç¤º**
   ```python
   st.caption(f"é¢„è§ˆå°ºå¯¸: {preview_w}Ã—{preview_w} px")
   ```

2. **æ·»åŠ è£å‰ªæ¡†å°ºå¯¸æ˜¾ç¤º**
   ```python
   st.caption(f"è£å‰ª: {cropped_img.width}Ã—{cropped_img.height} px")
   ```

3. **æ·»åŠ ç¼©æ”¾æ¯”ä¾‹æ˜¾ç¤º**
   ```python
   scale = preview_w / cropped_img.width
   st.caption(f"ç¼©æ”¾: {scale:.1f}x")
   ```

## ğŸ‰ æ€»ç»“

çƒ­å“åº”è£å‰ªé¢„è§ˆåŠŸèƒ½å·²å®Œæ•´å®ç°ï¼š
- âœ… **åŠ¨æ€ Key**: è‡ªåŠ¨é‡ç»˜è£å‰ªå™¨
- âœ… **çƒ­å“åº”**: å®æ—¶å“åº”æ‰€æœ‰å‚æ•°å˜åŒ–
- âœ… **æ— ç¼“å­˜**: ç¡®ä¿å³æ—¶æ›´æ–°
- âœ… **åŒè¯­æ”¯æŒ**: ä¸­è‹±æ–‡ caption
- âœ… **é«˜æ€§èƒ½**: < 100ms å“åº”æ—¶é—´

ç”¨æˆ·ç°åœ¨å¯ä»¥æµç•…åœ°è°ƒæ•´è£å‰ªåŒºåŸŸå’Œé¢„è§ˆå¤§å°ï¼Œè·å¾—å³æ—¶çš„è§†è§‰åé¦ˆï¼

---

**æ›´æ–°æ—¶é—´**: 2025-10-24  
**ç‰ˆæœ¬**: 6.2 (Hot-Reactive Preview)  
**çŠ¶æ€**: âœ… å®Œæˆå¹¶éªŒè¯é€šè¿‡

