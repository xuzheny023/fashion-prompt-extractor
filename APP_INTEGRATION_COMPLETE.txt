================================================================
   âœ… app_new.py é›†æˆå®Œæˆ
================================================================

ã€é›†æˆå†…å®¹ã€‘

  1. è°ƒç”¨ API âœ…
     res = analyze_image(
         patch_path,
         engine=engine,
         lang=lang,
         enable_web=enable_web,
         web_k=web_k,
         web_lang=web_lang
     )

  2. æ˜¾ç¤ºå¼•æ“ âœ…
     st.caption(f"Engine: {engine}")

  3. æ˜¾ç¤º Top-5 æè´¨ + ç½®ä¿¡åº¦æ¡ âœ…
     for i, name in enumerate(res["materials"][:5]):
         score = res["confidence"][i]
         st.write(f"**{i+1}. {name}**")
         st.progress(score)

  4. æ˜¾ç¤ºæ¨ç†æ–‡æœ¬ âœ…
     with st.expander("è§£é‡Š / Reasoning", expanded=False):
         st.write(res["description"])

  5. æ˜¾ç¤ºè¯æ®é“¾æ¥ âœ…
     with st.expander("è¯æ® / Evidence", expanded=False):
         for ev in evidence:
             label = ev.get("label")
             urls = ev.get("urls")
             st.write(f"**{label}:**")
             for url in urls:
                 st.markdown(f"  - [{url}]({url})")

ã€UI å¸ƒå±€ã€‘

  è¯†åˆ«æŒ‰é’®ç‚¹å‡»åæ˜¾ç¤º:
  
  Engine: cloud_qwen
  
  **1. å°ç¾Šçš®**
  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘ 55%
  
  **2. PUçš®é©**
  â–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘ 20%
  
  **3. ç‰›çš®**
  â–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘ 12%
  
  **4. æ¶¤çº¶**
  â–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘ 8%
  
  **5. å°¼é¾™**
  â–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘ 5%
  
  â–¶ è§£é‡Š / Reasoning
    åŸºäºè§†è§‰ç‰¹å¾å’Œè”ç½‘è¯æ®ï¼Œå°ç¾Šçš®çš„å¯èƒ½æ€§æœ€é«˜ï¼Œ
    å› ä¸ºè¡¨é¢çº¹ç†ç»†è…»ä¸”æœ‰è‡ªç„¶å…‰æ³½ã€‚PUçš®é©å’Œç‰›çš®
    ä¹Ÿæœ‰ä¸€å®šå¯èƒ½æ€§ï¼Œä½†å…‰æ³½åº¦å’Œè´¨æ„Ÿç•¥æœ‰å·®å¼‚ã€‚
  
  â–¶ è¯æ® / Evidence
    **å°ç¾Šçš®:**
      - https://baike.baidu.com/item/å°ç¾Šçš®
      - https://www.zhihu.com/question/...
    
    **PUçš®é©:**
      - https://baike.baidu.com/item/PU

ã€ä»£ç ä½ç½®ã€‘

  app_new.py (Line 125-165):
  
  â€¢ Line 125-133: API è°ƒç”¨
    - ä¼ é€’æ‰€æœ‰å‚æ•°
    - æ˜¾ç¤ºåŠ è½½æç¤º
  
  â€¢ Line 136: å¼•æ“æ˜¾ç¤º
    - st.caption(f"Engine: {engine}")
  
  â€¢ Line 138-149: Top-5 æè´¨
    - å¾ªç¯æ˜¾ç¤ºå‰5ä¸ª
    - ç½®ä¿¡åº¦è¿›åº¦æ¡
    - ç©ºç»“æœæç¤º
  
  â€¢ Line 151-154: æ¨ç†æ–‡æœ¬
    - å¯æŠ˜å  expander
    - é»˜è®¤æ”¶èµ·
  
  â€¢ Line 156-165: è¯æ®é“¾æ¥
    - å¯æŠ˜å  expander
    - æŒ‰é¢æ–™åˆ†ç»„
    - ç‚¹å‡»å¯è®¿é—®

ã€å‚æ•°ä¼ é€’ã€‘

  ä»ä¾§è¾¹æ åˆ° API:
  
  â€¢ engine: st.selectbox("äº‘ç«¯æ¨¡å‹")
  â€¢ lang: st.radio("è¯­è¨€")
  â€¢ enable_web: st.checkbox("å¯ç”¨è”ç½‘æ£€ç´¢")
  â€¢ web_k: st.slider("æ¯ä¸ªå€™é€‰æ£€ç´¢æ¡æ•°")
  â€¢ web_lang: st.radio("æ£€ç´¢è¯­è¨€")

ã€æ•°æ®æµã€‘

  ç”¨æˆ·è¾“å…¥
    â”œâ”€ engine (å¼•æ“é€‰æ‹©)
    â”œâ”€ lang (è¯­è¨€)
    â”œâ”€ enable_web (è”ç½‘å¼€å…³)
    â”œâ”€ web_k (æ£€ç´¢æ¡æ•°)
    â””â”€ web_lang (æ£€ç´¢è¯­è¨€)
    â†“
  analyze_image(...)
    â†“
  è¿”å›ç»“æœ
    â”œâ”€ materials: ["å°ç¾Šçš®", "PUçš®é©", ...]
    â”œâ”€ confidence: [0.55, 0.20, ...]
    â”œâ”€ description: "æ¨ç†æ–‡æœ¬"
    â”œâ”€ engine: "cloud_qwen"
    â””â”€ evidence: [{"label":"å°ç¾Šçš®", "urls":[...]}, ...]
    â†“
  UI æ¸²æŸ“
    â”œâ”€ Caption: Engine
    â”œâ”€ Top-5 + Progress bars
    â”œâ”€ Expander: è§£é‡Š / Reasoning
    â””â”€ Expander: è¯æ® / Evidence

ã€é”™è¯¯å¤„ç†ã€‘

  â€¢ NoAPIKeyError â†’ st.error("æœªæ£€æµ‹åˆ° DASHSCOPE_API_KEY...")
  â€¢ Exception â†’ st.error(f"äº‘ç«¯åˆ†æå¤±è´¥ï¼š{e}")
  â€¢ ç©º materials â†’ st.info("æœªä»æè¿°ä¸­æŠ½å–åˆ°æ˜ç¡®çš„é¢æ–™åç§°...")

ã€äº¤äº’æµç¨‹ã€‘

  1. ç”¨æˆ·ä¸Šä¼ å›¾ç‰‡
  2. è°ƒæ•´ä¾§è¾¹æ å‚æ•°
     â€¢ é€‰æ¡†å¤§å°
     â€¢ é¢„è§ˆæ”¾å¤§å€æ•°
     â€¢ è¯­è¨€
     â€¢ å¼•æ“
     â€¢ è”ç½‘å¼€å…³
     â€¢ æ£€ç´¢æ¡æ•°
  3. æ‹–åŠ¨è£å‰ªæ¡†
  4. æŸ¥çœ‹å®æ—¶é¢„è§ˆ
  5. ç‚¹å‡»"è¯†åˆ«è¯¥åŒºåŸŸ"
  6. æ˜¾ç¤ºåŠ è½½æç¤º
     â€¢ "è¯†åˆ«ä¸­â€¦" (enable_web=False)
     â€¢ "è¯†åˆ«ä¸­â€¦ + è”ç½‘éªŒè¯â€¦" (enable_web=True)
  7. æ¸²æŸ“ç»“æœ
     â€¢ Engine caption
     â€¢ Top-5 æè´¨ + ç½®ä¿¡åº¦
     â€¢ æ¨ç†æ–‡æœ¬ (expander)
     â€¢ è¯æ®é“¾æ¥ (expander, å¦‚æœæœ‰)

ã€å“åº”å¼è®¾è®¡ã€‘

  â€¢ col_img (2/3 å®½åº¦): è£å‰ªç•Œé¢
  â€¢ col_info (1/3 å®½åº¦): é¢„è§ˆ + è¯†åˆ«æŒ‰é’® + ç»“æœ

ã€éªŒæ”¶æ¸…å•ã€‘

  [âœ“] API è°ƒç”¨å‚æ•°å®Œæ•´
  [âœ“] Engine caption æ˜¾ç¤º
  [âœ“] Top-5 æè´¨æ˜¾ç¤º
  [âœ“] ç½®ä¿¡åº¦è¿›åº¦æ¡
  [âœ“] æ¨ç†æ–‡æœ¬ expander
  [âœ“] è¯æ®é“¾æ¥ expander
  [âœ“] æŒ‰é¢æ–™åˆ†ç»„æ˜¾ç¤ºè¯æ®
  [âœ“] å¯ç‚¹å‡»çš„ URL é“¾æ¥
  [âœ“] é”™è¯¯å¤„ç†
  [âœ“] ç©ºç»“æœæç¤º
  [âœ“] åŠ è½½æç¤º

ã€UI ç»†èŠ‚ã€‘

  â€¢ æè´¨åç§°: åŠ ç²—æ˜¾ç¤º (**{i+1}. {name}**)
  â€¢ ç½®ä¿¡åº¦: è¿›åº¦æ¡ (st.progress)
  â€¢ Expander: é»˜è®¤æ”¶èµ· (expanded=False)
  â€¢ URL: Markdown é“¾æ¥æ ¼å¼ ([url](url))
  â€¢ åˆ†ç»„: æ¯ä¸ªé¢æ–™ç‹¬ç«‹æ˜¾ç¤ºè¯æ®
  â€¢ ç¼©è¿›: è¯æ® URL ä½¿ç”¨ "  - " ç¼©è¿›

ã€ç¤ºä¾‹è¾“å‡ºã€‘

  å½“ enable_web=True æ—¶:
  
    Engine: cloud_qwen
    
    1. å°ç¾Šçš®        â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 55%
    2. PUçš®é©        â–ˆâ–ˆâ–ˆâ–ˆ 20%
    3. ç‰›çš®          â–ˆâ–ˆâ–ˆ 12%
    4. æ¶¤çº¶          â–ˆâ–ˆ 8%
    5. å°¼é¾™          â–ˆ 5%
    
    â–¶ è§£é‡Š / Reasoning
      [æ¨ç†æ–‡æœ¬]
    
    â–¶ è¯æ® / Evidence
      å°ç¾Šçš®:
        - [URL 1]
        - [URL 2]
      PUçš®é©:
        - [URL 3]

  å½“ enable_web=False æ—¶:
  
    Engine: cloud_qwen
    
    1. å°ç¾Šçš®        â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 55%
    2. PUçš®é©        â–ˆâ–ˆâ–ˆâ–ˆ 20%
    3. ç‰›çš®          â–ˆâ–ˆâ–ˆ 12%
    4. æ¶¤çº¶          â–ˆâ–ˆ 8%
    5. å°¼é¾™          â–ˆ 5%
    
    â–¶ è§£é‡Š / Reasoning
      [æ¨ç†æ–‡æœ¬]
    
    (æ— è¯æ® expander)

ã€æ€§èƒ½ä¼˜åŒ–ã€‘

  â€¢ st.spinner: æ˜¾ç¤ºåŠ è½½çŠ¶æ€
  â€¢ æ¡ä»¶æ¸²æŸ“: ä»…åœ¨æœ‰æ•°æ®æ—¶æ˜¾ç¤º
  â€¢ é™åˆ¶æ•°é‡: Top-5, æ¯ä¸ªè¯æ®æœ€å¤š3ä¸ªURL

ã€å¯è®¿é—®æ€§ã€‘

  â€¢ æ¸…æ™°çš„æ ‡ç­¾ (è§£é‡Š / Reasoning, è¯æ® / Evidence)
  â€¢ å¯ç‚¹å‡»çš„é“¾æ¥
  â€¢ è¿›åº¦æ¡è§†è§‰åé¦ˆ
  â€¢ é”™è¯¯æç¤ºç”¨æˆ·å‹å¥½

================================================================
   ğŸ‰ app_new.py é›†æˆå®Œæˆï¼
================================================================

æ›´æ–°æ—¶é—´: 2025-10-24
ç‰ˆæœ¬: 9.0 (Open-Set + RAG + Integration)
çŠ¶æ€: âœ… å·²å®ç°å¹¶éªŒè¯

