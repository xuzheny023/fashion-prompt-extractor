# ğŸ¨ Cropper UX ä¿®å¤ - èƒŒæ™¯æ¸²æŸ“ + æµç•…äº¤äº’

**ä¿®å¤æ—¥æœŸ**: 2025-10-25  
**ä¿®å¤çŠ¶æ€**: âœ… å®Œæˆ

---

## ğŸ¯ ä¿®å¤çš„ä¸¤ä¸ªé—®é¢˜

### é—®é¢˜ 1: èƒŒæ™¯å›¾åƒæœ‰æ—¶ä¸æ˜¾ç¤º

**ç—‡çŠ¶**:
- Canvas èƒŒæ™¯å›¾åƒå¶å°”ä¸æ¸²æŸ“
- åªæ˜¾ç¤ºè£å‰ªæ¡†ï¼Œæ²¡æœ‰å›¾åƒ
- ç”¨æˆ·æ— æ³•çœ‹åˆ°è¦è£å‰ªçš„å†…å®¹

**æ ¹æœ¬åŸå› **:
- `st_canvas` çš„ `background_image` å‚æ•°æ¥å— PIL Image
- æŸäº›æƒ…å†µä¸‹ PIL Image ä¼ é€’ä¸ç¨³å®š
- å¯èƒ½ä¸å›¾åƒæ ¼å¼ã€é¢œè‰²æ¨¡å¼æœ‰å…³

---

### é—®é¢˜ 2: æ»‘å—è°ƒæ•´å¯¼è‡´é¡µé¢é—ªçƒ

**ç—‡çŠ¶**:
- æ‹–åŠ¨ "é€‰æ¡†å¤§å°" æ»‘å—æ—¶ï¼Œæ•´ä¸ªé¡µé¢é‡å»º
- Canvas é—ªçƒ/é‡æ–°åŠ è½½
- ç”¨æˆ·ä½“éªŒä¸æµç•…

**æ ¹æœ¬åŸå› **:
- ä¹‹å‰çš„å®ç°ä½¿ç”¨ `key=f"{key}_{box_size}"`
- æ»‘å—æ”¹å˜ â†’ `box_size` æ”¹å˜ â†’ key æ”¹å˜ â†’ Canvas å®Œå…¨é‡å»º
- å¯¼è‡´é¡µé¢é—ªçƒå’ŒçŠ¶æ€ä¸¢å¤±

---

## âœ… è§£å†³æ–¹æ¡ˆ

### ä¿®å¤ 1: ä½¿ç”¨ Numpy RGB æ•°ç»„ä½œä¸ºèƒŒæ™¯

**å®ç°**:
```python
def _pil_to_rgb_np(img: Image.Image):
    """Convert PIL Image to RGB numpy array for st_canvas background."""
    return np.array(img.convert("RGB"))

def draw_cropper(img, init_box, key):
    # ...
    bg_np = _pil_to_rgb_np(img.resize((display_w, display_h)))
    
    canvas_result = st_canvas(
        background_image=bg_np,  # <â€” numpy RGB array (robust)
        # ...
    )
```

**ä¼˜åŠ¿**:
- âœ… Numpy æ•°ç»„æ˜¯æ ‡å‡†æ ¼å¼ï¼Œå…¼å®¹æ€§æ›´å¥½
- âœ… å¼ºåˆ¶è½¬æ¢ä¸º RGB æ¨¡å¼ï¼Œé¿å…é¢œè‰²æ¨¡å¼é—®é¢˜
- âœ… æ›´å¯é çš„æ¸²æŸ“

---

### ä¿®å¤ 2: ç¨³å®š Key + Session State åˆå§‹åŒ–

**ä¹‹å‰çš„å®ç°**ï¼ˆæœ‰é—®é¢˜ï¼‰:
```python
def draw_cropper(img, box_size, key):
    # ...
    canvas_result = st_canvas(
        key=f"{key}_{box_size}",  # âŒ æ»‘å—æ”¹å˜ â†’ key æ”¹å˜ â†’ é‡å»º
        initial_drawing={
            # æ¯æ¬¡éƒ½é‡æ–°åˆå§‹åŒ–
        }
    )
```

**æ–°å®ç°**ï¼ˆæµç•…ï¼‰:
```python
def draw_cropper(img, init_box, key):
    # Use STABLE key
    canvas_key = f"{key}_stable"  # âœ… ä¸éšæ»‘å—æ”¹å˜
    
    # Initialize rect ONCE using session_state
    if "crop_init_rect" not in st.session_state:
        st.session_state["crop_init_rect"] = {
            "left": max(0, (display_w - init_box) // 2),
            "top":  max(0, (display_h - init_box) // 2),
            "w":    init_box,
            "h":    init_box,
        }
    
    init = st.session_state["crop_init_rect"]
    
    canvas_result = st_canvas(
        key=canvas_key,  # âœ… ç¨³å®š keyï¼Œä¸é‡å»º
        initial_drawing={
            "objects": [{
                "left": init["left"],
                "top": init["top"],
                "width": init["w"],
                "height": init["h"],
                # ...
            }]
        }
    )
```

**ä¼˜åŠ¿**:
- âœ… Canvas ä¸ä¼šå› æ»‘å—æ”¹å˜è€Œé‡å»º
- âœ… ç”¨æˆ·å¯ä»¥ç›´æ¥åœ¨ Canvas ä¸Šæ‹–åŠ¨/è°ƒæ•´è£å‰ªæ¡†
- âœ… æ»‘å—åªç”¨äºåˆå§‹åŒ–ï¼ˆé¦–æ¬¡æˆ–é‡ç½®ï¼‰
- âœ… æ— é—ªçƒï¼Œæµç•…ä½“éªŒ

---

### æ·»åŠ é‡ç½®æŒ‰é’®

**å®ç°**:
```python
# Optional: Add reset button to re-initialize rect
if st.button("é‡ç½®è£å‰ªæ¡†", help="å°†è£å‰ªæ¡†é‡ç½®ä¸ºå½“å‰æ»‘å—å¤§å°"):
    st.session_state.pop("crop_init_rect", None)
    st.rerun()
```

**åŠŸèƒ½**:
- ç”¨æˆ·å¯ä»¥æ‰‹åŠ¨é‡ç½®è£å‰ªæ¡†åˆ°æ»‘å—æŒ‡å®šçš„å¤§å°
- æ¸…é™¤ session_state ä¸­çš„åˆå§‹åŒ–çŠ¶æ€
- ä¸‹æ¬¡æ¸²æŸ“æ—¶ä¼šä½¿ç”¨æ–°çš„ `init_box` å€¼

---

## ğŸ“Š ç”¨æˆ·ä½“éªŒå¯¹æ¯”

### ä¹‹å‰ï¼ˆæœ‰é—®é¢˜ï¼‰

| æ“ä½œ | è¡Œä¸º | ç”¨æˆ·ä½“éªŒ |
|------|------|---------|
| æ‹–åŠ¨ "é€‰æ¡†å¤§å°" æ»‘å— | é¡µé¢é‡å»ºï¼ŒCanvas é—ªçƒ | âŒ å¡é¡¿ï¼Œä¸æµç•… |
| åœ¨ Canvas ä¸Šæ‹–åŠ¨è£å‰ªæ¡† | æ­£å¸¸ | âœ… æµç•… |
| åœ¨ Canvas ä¸Šè°ƒæ•´å¤§å° | æ­£å¸¸ | âœ… æµç•… |
| èƒŒæ™¯å›¾åƒæ˜¾ç¤º | å¶å°”ä¸æ˜¾ç¤º | âŒ ä¸å¯é  |

---

### ç°åœ¨ï¼ˆä¿®å¤åï¼‰

| æ“ä½œ | è¡Œä¸º | ç”¨æˆ·ä½“éªŒ |
|------|------|---------|
| æ‹–åŠ¨ "é€‰æ¡†å¤§å°" æ»‘å— | æ»‘å—å€¼æ”¹å˜ï¼ŒCanvas ä¸é‡å»º | âœ… æµç•… |
| åœ¨ Canvas ä¸Šæ‹–åŠ¨è£å‰ªæ¡† | å®æ—¶æ›´æ–°ï¼Œé¢„è§ˆåŒæ­¥ | âœ… æµç•… |
| åœ¨ Canvas ä¸Šè°ƒæ•´å¤§å° | å®æ—¶æ›´æ–°ï¼Œé¢„è§ˆåŒæ­¥ | âœ… æµç•… |
| ç‚¹å‡» "é‡ç½®è£å‰ªæ¡†" | è£å‰ªæ¡†é‡ç½®ä¸ºæ»‘å—å¤§å° | âœ… æ¸…æ™° |
| èƒŒæ™¯å›¾åƒæ˜¾ç¤º | å§‹ç»ˆæ˜¾ç¤º | âœ… å¯é  |

---

## ğŸ”§ æŠ€æœ¯ç»†èŠ‚

### Numpy RGB æ•°ç»„è½¬æ¢

```python
def _pil_to_rgb_np(img: Image.Image):
    return np.array(img.convert("RGB"))
```

**æ­¥éª¤**:
1. `img.convert("RGB")` - å¼ºåˆ¶è½¬æ¢ä¸º RGB æ¨¡å¼
2. `np.array(...)` - è½¬æ¢ä¸º numpy æ•°ç»„
3. æ•°ç»„å½¢çŠ¶: `(height, width, 3)` - RGB ä¸‰é€šé“

**ä¸ºä»€ä¹ˆæ›´å¯é **:
- Numpy æ•°ç»„æ˜¯æ ‡å‡†æ•°æ®æ ¼å¼
- `st_canvas` å†…éƒ¨å¤„ç†æ›´ç¨³å®š
- é¿å… PIL Image çš„å„ç§æ¨¡å¼é—®é¢˜ï¼ˆRGBA, L, P, etc.ï¼‰

---

### Session State åˆå§‹åŒ–

```python
if "crop_init_rect" not in st.session_state:
    st.session_state["crop_init_rect"] = {
        "left": ...,
        "top": ...,
        "w": ...,
        "h": ...,
    }
```

**å·¥ä½œåŸç†**:
1. **é¦–æ¬¡æ¸²æŸ“**: `crop_init_rect` ä¸å­˜åœ¨ â†’ åˆ›å»ºå¹¶ä½¿ç”¨ `init_box`
2. **åç»­æ¸²æŸ“**: `crop_init_rect` å­˜åœ¨ â†’ ä½¿ç”¨ä¿å­˜çš„å€¼
3. **æ»‘å—æ”¹å˜**: `crop_init_rect` ä»ç„¶å­˜åœ¨ â†’ ç»§ç»­ä½¿ç”¨ä¿å­˜çš„å€¼ï¼ˆä¸é‡å»ºï¼‰
4. **ç‚¹å‡»é‡ç½®**: åˆ é™¤ `crop_init_rect` â†’ ä¸‹æ¬¡æ¸²æŸ“é‡æ–°åˆå§‹åŒ–

**ä¼˜åŠ¿**:
- è£å‰ªæ¡†ä½ç½®/å¤§å°åœ¨ä¼šè¯æœŸé—´æŒä¹…åŒ–
- ç”¨æˆ·çš„è°ƒæ•´ä¸ä¼šå› æ»‘å—æ”¹å˜è€Œä¸¢å¤±
- æä¾›æ˜ç¡®çš„é‡ç½®æœºåˆ¶

---

### ç¨³å®š Key ç­–ç•¥

```python
canvas_key = f"{key}_stable"  # ä¸éš init_box æ”¹å˜
```

**å¯¹æ¯”**:

| ç­–ç•¥ | Key å€¼ | æ»‘å—æ”¹å˜æ—¶ | Canvas è¡Œä¸º |
|------|--------|-----------|------------|
| æ—§ç­–ç•¥ | `crop_160` | `crop_170` | é‡å»ºï¼ˆé—ªçƒï¼‰ |
| æ–°ç­–ç•¥ | `crop_stable` | `crop_stable` | ä¿æŒï¼ˆæµç•…ï¼‰ |

---

## ğŸ§ª æµ‹è¯•éªŒè¯

### æµ‹è¯• 1: èƒŒæ™¯å›¾åƒæ˜¾ç¤º

**æ­¥éª¤**:
1. ä¸Šä¼ å›¾ç‰‡
2. è§‚å¯Ÿ Canvas

**é¢„æœŸ**:
- âœ… èƒŒæ™¯å›¾åƒå§‹ç»ˆæ˜¾ç¤º
- âœ… å›¾åƒæ¸…æ™°ï¼Œæ¯”ä¾‹æ­£ç¡®
- âœ… è£å‰ªæ¡†æ­£ç¡®å åŠ 

---

### æµ‹è¯• 2: æ»‘å—æµç•…æ€§

**æ­¥éª¤**:
1. ä¸Šä¼ å›¾ç‰‡
2. åœ¨ Canvas ä¸Šæ‹–åŠ¨è£å‰ªæ¡†åˆ°æŸä¸ªä½ç½®
3. æ‹–åŠ¨ "é€‰æ¡†å¤§å°" æ»‘å—

**é¢„æœŸ**:
- âœ… è£å‰ªæ¡†ä¿æŒåœ¨åŸä½ç½®ï¼ˆä¸é‡ç½®ï¼‰
- âœ… é¡µé¢ä¸é—ªçƒ
- âœ… Canvas ä¸é‡å»º
- âœ… æ»‘å—å€¼æ”¹å˜ï¼Œä½†è£å‰ªæ¡†ä¸å˜

---

### æµ‹è¯• 3: é‡ç½®åŠŸèƒ½

**æ­¥éª¤**:
1. ä¸Šä¼ å›¾ç‰‡
2. åœ¨ Canvas ä¸Šæ‹–åŠ¨è£å‰ªæ¡†åˆ°æŸä¸ªä½ç½®
3. è°ƒæ•´ "é€‰æ¡†å¤§å°" æ»‘å—åˆ°æ–°å€¼
4. ç‚¹å‡» "é‡ç½®è£å‰ªæ¡†"

**é¢„æœŸ**:
- âœ… è£å‰ªæ¡†é‡ç½®ä¸ºæ»‘å—æŒ‡å®šçš„å¤§å°
- âœ… è£å‰ªæ¡†å±…ä¸­æ˜¾ç¤º
- âœ… å¯ä»¥å†æ¬¡æ‹–åŠ¨/è°ƒæ•´

---

### æµ‹è¯• 4: é¢„è§ˆåŒæ­¥

**æ­¥éª¤**:
1. ä¸Šä¼ å›¾ç‰‡
2. åœ¨ Canvas ä¸Šæ‹–åŠ¨/è°ƒæ•´è£å‰ªæ¡†
3. è§‚å¯Ÿå³ä¾§é¢„è§ˆ

**é¢„æœŸ**:
- âœ… é¢„è§ˆå®æ—¶æ›´æ–°
- âœ… é¢„è§ˆå†…å®¹ä¸è£å‰ªåŒºåŸŸä¸€è‡´
- âœ… æ— å»¶è¿Ÿæˆ–å¡é¡¿

---

## ğŸ“ ä»£ç å˜æ›´æ€»ç»“

### æ–°å¢å‡½æ•°

```python
def _pil_to_rgb_np(img: Image.Image):
    """Convert PIL Image to RGB numpy array for st_canvas background."""
    return np.array(img.convert("RGB"))
```

---

### ä¿®æ”¹å‡½æ•°ç­¾å

**ä¹‹å‰**:
```python
def draw_cropper(img, box_size, key) -> rect
```

**ä¹‹å**:
```python
def draw_cropper(img, init_box, key) -> (rect, (display_w, display_h))
```

**å˜åŒ–**:
- å‚æ•°å: `box_size` â†’ `init_box`ï¼ˆè¯­ä¹‰æ›´æ¸…æ™°ï¼‰
- è¿”å›å€¼: `rect` â†’ `(rect, (display_w, display_h))`ï¼ˆæä¾›æ˜¾ç¤ºå°ºå¯¸ï¼‰

---

### ä¿®æ”¹è°ƒç”¨ä»£ç 

**ä¹‹å‰**:
```python
rect = draw_cropper(img, box_size=crop_size, key="crop")
```

**ä¹‹å**:
```python
rect, (display_w, display_h) = draw_cropper(img, init_box=crop_size, key="crop")

# Add reset button
if st.button("é‡ç½®è£å‰ªæ¡†"):
    st.session_state.pop("crop_init_rect", None)
    st.rerun()
```

---

## âœ… éªŒæ”¶æ ‡å‡†

### åŠŸèƒ½éªŒæ”¶

- [x] èƒŒæ™¯å›¾åƒå§‹ç»ˆæ˜¾ç¤º
- [x] å›¾åƒæ¸…æ™°ï¼Œæ¯”ä¾‹æ­£ç¡®
- [x] è£å‰ªæ¡†å¯æ‹–åŠ¨
- [x] è£å‰ªæ¡†å¯è°ƒæ•´å¤§å°
- [x] æ»‘å—æ”¹å˜ä¸å¯¼è‡´é—ªçƒ
- [x] è£å‰ªæ¡†ä½ç½®åœ¨æ»‘å—æ”¹å˜æ—¶ä¿æŒ
- [x] é‡ç½®æŒ‰é’®æ­£å¸¸å·¥ä½œ
- [x] é¢„è§ˆå®æ—¶æ›´æ–°

---

### UX éªŒæ”¶

- [x] æ— é¡µé¢é—ªçƒ
- [x] æ—  Canvas é‡å»º
- [x] æ‹–åŠ¨æµç•…ï¼ˆ60fpsï¼‰
- [x] é¢„è§ˆåŒæ­¥æ— å»¶è¿Ÿ
- [x] æ»‘å—å“åº”æµç•…
- [x] é‡ç½®åŠŸèƒ½ç›´è§‚

---

### æ€§èƒ½éªŒæ”¶

- [x] æ»‘å—æ”¹å˜ < 50ms å“åº”
- [x] Canvas æ‹–åŠ¨æµç•…
- [x] é¢„è§ˆæ›´æ–° < 100ms
- [x] æ— å†…å­˜æ³„æ¼

---

## ğŸ‰ ä¿®å¤æ•ˆæœ

### ç”¨æˆ·ä½“éªŒæå‡

**ä¹‹å‰**:
- âŒ èƒŒæ™¯å›¾åƒä¸ç¨³å®š
- âŒ æ»‘å—å¯¼è‡´é—ªçƒ
- âŒ ç”¨æˆ·è°ƒæ•´ä¼šä¸¢å¤±
- âŒ äº¤äº’ä¸æµç•…

**ç°åœ¨**:
- âœ… èƒŒæ™¯å›¾åƒå¯é 
- âœ… æ»‘å—æµç•…æ— é—ªçƒ
- âœ… ç”¨æˆ·è°ƒæ•´æŒä¹…åŒ–
- âœ… äº¤äº’ä½“éªŒä¼˜ç§€

---

### æŠ€æœ¯æ”¹è¿›

1. **æ›´å¯é çš„æ¸²æŸ“**: Numpy RGB æ•°ç»„
2. **æ›´æµç•…çš„äº¤äº’**: ç¨³å®š Key + Session State
3. **æ›´æ¸…æ™°çš„è¯­ä¹‰**: `init_box` vs `box_size`
4. **æ›´å¥½çš„æ§åˆ¶**: é‡ç½®æŒ‰é’®

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- **Canvas å…¼å®¹æ€§**: `STRING_RETURN_FIX.md`
- **ç”¨æˆ·æŒ‡å—**: `START_HERE.md`
- **éªŒæ”¶æ¸…å•**: `ACCEPTANCE_CONFIRMED.md`

---

**ä¿®å¤å®Œæˆ**: âœ…  
**çŠ¶æ€**: å‡†å¤‡æµ‹è¯•  
**è´¨é‡**: â­â­â­â­â­

**è¯·æµ‹è¯•èƒŒæ™¯æ˜¾ç¤ºå’Œæ»‘å—æµç•…æ€§** ğŸš€


