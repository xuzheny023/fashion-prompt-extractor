# CLIP 面料识别 - UI 使用指南

## 🎨 UI 功能说明

### 启用 CLIP 检索

在左侧边栏找到并勾选：
```
🔬 使用 CLIP 向量检索 (实验性)
```

### 进度条显示

上传图片后，系统会显示分阶段进度：

```
🧠 使用 CLIP 双通道向量检索…

进度条：
[████░░░░░░] 5%   - 初始化模型与数据…
[████████░░] 25%  - 已生成查询向量 (1536维)…
[████████████░░] 40% - 进行类中心粗排（TopC=12）…
[████████████████████] 85% - 类内精排完成…
[████████████████████████] 100% - ✓ 完成：27 ms
```

### 结果显示

#### 1. 性能指标
```
📊 粗排最高分: 0.856 · 检索用时: 27 ms
```

- **粗排最高分**：类中心匹配的最高相似度（0-1，越接近1越相似）
- **检索用时**：从编码到精排完成的总时间（毫秒）

#### 2. Top-5 推荐

```
1. 牛仔面料 — 分数: 0.86
[████████████████░░░░] 86%

2. 帆布 — 分数: 0.72
[██████████████░░░░░░] 72%

3. 斜纹布 — 分数: 0.65
[█████████████░░░░░░░] 65%
⚠️ 建议人工确认/补图

4. 灯芯绒 — 分数: 0.58
[███████████░░░░░░░░░] 58%
⚠️ 建议人工确认/补图

5. 亚麻 — 分数: 0.52
[██████████░░░░░░░░░░] 52%
⚠️ 建议人工确认/补图
```

#### 3. 置信度解读

| 置信度范围 | 颜色 | 说明 |
|-----------|------|------|
| ≥ 70% | 🟢 绿色 | 高可信度，可直接采用 |
| 30-70% | 🟡 黄色 | 中等可信度，建议复核 |
| < 30% | 🔴 红色 | 低可信度，显示"⚠️ 建议人工确认/补图" |

## ⚡ 性能说明

### 检索速度

典型情况下（64个类别，每类8个样本）：

| 阶段 | 时间 | 说明 |
|------|------|------|
| 预加载 | ~0ms | 缓存后几乎瞬间 |
| 编码查询 | 50-100ms | CLIP 模型推理 |
| 粗排 | 2-5ms | 类中心矩阵点积 |
| 精排 | 20-60ms | Top-12 类全样本比对 |
| **总计** | **70-170ms** | 含编码时间 |

### 首次加载

首次使用会稍慢（需要加载模型）：
- HuggingFace CLIP: ~2秒
- LAION CLIP: ~3秒
- 向量库加载: ~0.5秒

后续使用会快很多（缓存生效）！

## 🔧 高级功能

### 调整精排候选数

在 `src/fabric_clip_ranker.py` 中修改：

```python
TOPC = 12  # 默认值

# 建议：
# - 快速模式：TOPC = 8
# - 平衡模式：TOPC = 12（推荐）
# - 准确模式：TOPC = 20
```

修改后需要重启 Streamlit。

### 启用 FAISS 加速

```powershell
# 安装 FAISS
.\venv\Scripts\pip.exe install faiss-cpu

# 重启 Streamlit
# 系统会自动检测并使用 FAISS
```

检索时间可进一步降低到 **20-30ms**！

## 📊 对比：规则基 vs CLIP

### 规则基推荐（传统）

**优点**：
- 可解释性强（基于颜色、光泽、纹理规则）
- 可手动调整权重
- 无需向量库

**缺点**：
- 需要手工编写大量规则
- 难以覆盖所有面料类型
- 对新面料适应性差

### CLIP 向量检索（实验性）

**优点**：
- 端到端学习，无需手工规则
- 泛化能力强
- 可快速扩展到新类别（只需加图片）
- 速度快（优化后）

**缺点**：
- 需要构建向量库
- 黑盒模型，可解释性较弱
- 依赖样本质量

## 🎯 使用建议

### 何时使用 CLIP

✅ **推荐使用**：
- 面料类型清晰、单一
- 图片质量好（清晰、无印花、光线均匀）
- 需要快速识别
- 有充足的样本图片（每类≥5张）

❌ **不推荐**：
- 复杂混合材质
- 图片模糊或角度不佳
- 印花过于复杂
- 样本数不足（<3张）

### 最佳实践

1. **上传前预处理**：
   - 裁剪到面料区域
   - 确保光线均匀
   - 避免印花干扰

2. **结果复核**：
   - 置信度 < 70% 时建议人工确认
   - 对比多个候选结果
   - 参考粗排最高分

3. **持续优化**：
   - 补充低置信度类别的样本
   - 删除质量差的样本
   - 定期重建向量库

## 🐛 常见问题

### Q: 进度条一直卡在 5%？

A: 可能是首次加载 CLIP 模型。请等待 3-5 秒。如果超过 10 秒，刷新页面重试。

### Q: 识别速度很慢（>500ms）？

A: 
1. 检查图片大小（建议 ≤1024px）
2. 考虑安装 FAISS 加速
3. 减少 TOPC 参数

### Q: 识别结果不准？

A: 
1. 检查该类别的样本数量和质量
2. 尝试重新拍摄更清晰的图片
3. 补充样本后重建向量库

### Q: "向量库未找到" 错误？

A: 运行以下命令构建向量库：
```powershell
cd D:\fashion-prompt-extractor
$env:PYTHONUNBUFFERED="1"
.\venv\Scripts\python.exe -u tools\build_fabric_bank.py
```

## 📈 未来改进方向

- [ ] 支持多区域批量识别
- [ ] 添加不确定度估计
- [ ] 支持混合材质识别
- [ ] 在线学习和增量更新
- [ ] 移动端优化（模型量化）

---

**版本**: 1.0  
**更新时间**: 2025-10-12  
**反馈**: 如有问题或建议，请提交 Issue


